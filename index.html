
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
    <title>Gifts Battle</title>
    
    <!-- External Libraries -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React 18 UMD -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Global Styles -->
    <style>
      :root {
        --bg-main: #0D0D10;
        --bg-card: #16161A;
        --text-main: #F5F5F7;
        --accent-gold: #EAB308;
      }

      body {
        background-color: var(--bg-main);
        color: var(--text-main);
        font-family: 'Inter', sans-serif;
        overscroll-behavior: none;
        padding-bottom: 0;
        -webkit-font-smoothing: antialiased;
        margin: 0;
        user-select: none;
        -webkit-user-select: none;
        -webkit-tap-highlight-color: transparent;
      }

      /* Hide scrollbar */
      ::-webkit-scrollbar { display: none; }
      * { -ms-overflow-style: none; scrollbar-width: none; }

      .animate-fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

      .upgrade-fade-out { opacity: 0; transform: scale(0.9); transition: all 0.6s ease-out; }
      .upgrade-success-pop { animation: popSuccess 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
      @keyframes popSuccess {
        0% { transform: scale(1); }
        50% { transform: scale(1.15); filter: brightness(1.2); }
        100% { transform: scale(1); filter: brightness(1); }
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
</head>
  <body>
    <div id="root"></div>

    <!-- Application Logic -->
    <script type="text/babel">
      const { useState, useEffect, useRef, useMemo } = React;

      // --- CONSTANTS & CONFIG ---
      
      const Rarity = {
        COMMON: 'COMMON',
        RARE: 'RARE',
        EPIC: 'EPIC',
        LEGENDARY: 'LEGENDARY'
      };

      // Gift Images
      const IMG_GIFT_CAT = "https://i.ibb.co/NdXSDY0X/f2aa355890cc49b2b47c3fddde527bd5-Scared-Cat-Celestia.webp";
      const IMG_GIFT_SIGN = "https://i.ibb.co/C309w4MG/e70ef163ca8e4bbeb171c270ceeefd1a-Westside-Sign-Sapphire.webp";
      const IMG_GIFT_CAPTAIN = "https://i.ibb.co/21s07HnX/Captain.webp";
      const IMG_GIFT_SALTWATER = "https://i.ibb.co/TqRygLZD/Saltwater.webp";
      const IMG_GIFT_DIPPER = "https://i.ibb.co/KxTpL9pG/Dipper.webp";
      const IMG_GIFT_LOOTBAG = "https://i.ibb.co/RTHKf4fz/0a6cc79a0d11441aa93bde7c49e7f177-Loot-Bag-Courchevel.webp";
      const IMG_GIFT_TELEGRAM = "https://i.ibb.co/KpKTgrjC/Telegram.webp";
      const IMG_GIFT_VERIFICATION = "https://i.ibb.co/fGNJ2wxY/Input-Key-Verification-aaa.webp";

      // Evilholic Items
      const IMG_EVIL_DAYTONA = "https://i.ibb.co/sv6M8PZj/Blue-Daytona.webp";
      const IMG_EVIL_CUB = "https://i.ibb.co/fGGmJznh/Golden-Cub.webp";
      const IMG_EVIL_SPACE = "https://i.ibb.co/v4CJJW3C/Space-Travel.webp";
      const IMG_EVIL_RALLY = "https://i.ibb.co/TMCJ8Spj/Market-Rally.webp";
      const IMG_EVIL_RIOT = "https://i.ibb.co/Rk78wz2w/Riot-Pack.webp";
      const IMG_EVIL_NEPTUNE = "https://i.ibb.co/cXNMfLCL/Neptune.webp";
      const IMG_EVIL_FROG = "https://i.ibb.co/svRgz79x/Gummy-Frog.webp";
      const IMG_EVIL_TURTLES = "https://i.ibb.co/4ng79f3k/Turtles.webp";
      const IMG_EVIL_ELVEN = "https://i.ibb.co/F47mKRB3/Elven-Might.webp";
      const IMG_EVIL_PEPE = "https://i.ibb.co/nsN61dvy/65349e0f3a63466e9bbc363d7fba12cc-Plush-Pepe-Raphael.webp";

      // Cases
      const IMG_CASE_1 = "https://i.ibb.co/kszCsN2z/case1.png";
      const IMG_CASE_EVILHOLIC = "https://i.ibb.co/HDBsfG9m/Gemini-Generated-Image-bnrq5zbnrq5zbnrq.png";
      const IMG_CASE_3 = "https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXU5A1PIYQNqhpOSV-fRPasw8rsUFJ5KBFZv668FFU4naLOJzgUuYqxz4XZk_L1YO_UwGkG6sEp2rGY89n32wbsqkA6MDr2I46LMlh53L8yIqE/360fx360f";
      const IMG_CASE_4 = "https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXU5A1PIYQNqhpOSV-fRPasw8rsUFJ5KBFZv668FFYwnfKfcG9H69z5i4VZl_T2MbjUzmQFu8Ry3rnD8I2i0VDm-RVsMm-lLY6LMlh5P3fVwA/360fx360f";

      const ITEMS = [
        // Dervuz Items
        { id: 'g_key', name: 'Input-Key-Verification', price: 3584, rarity: Rarity.COMMON, color: '#4b69ff', image: IMG_GIFT_VERIFICATION },
        { id: 'g_tg', name: 'Telegram', price: 6928, rarity: Rarity.COMMON, color: '#4b69ff', image: IMG_GIFT_TELEGRAM },
        // Rare
        { id: 'g_cat', name: 'Scared Cat Celestia', price: 13125, rarity: Rarity.RARE, color: '#8847ff', image: IMG_GIFT_CAT },
        { id: 'g_loot', name: 'Loot-Bag-Courchevel', price: 29990, rarity: Rarity.RARE, color: '#8847ff', image: IMG_GIFT_LOOTBAG },
        // Epic
        { id: 'g_salt', name: 'Saltwater', price: 30731, rarity: Rarity.EPIC, color: '#d32ce6', image: IMG_GIFT_SALTWATER },
        { id: 'g_sign', name: 'Westside-Sign-Sapphire', price: 37943, rarity: Rarity.EPIC, color: '#d32ce6', image: IMG_GIFT_SIGN },
        // Legendary
        { id: 'g_capt', name: 'Captain', price: 179099, rarity: Rarity.LEGENDARY, color: '#eb4b4b', image: IMG_GIFT_CAPTAIN },
        { id: 'g_dip', name: 'Dipper', price: 1300765, rarity: Rarity.LEGENDARY, color: '#e4ae39', image: IMG_GIFT_DIPPER },

        // Evilholic Items
        { id: 'e_daytona', name: 'Blue Daytona', price: 4500, rarity: Rarity.COMMON, color: '#4b69ff', image: IMG_EVIL_DAYTONA },
        { id: 'e_cub', name: 'Golden Cub', price: 6200, rarity: Rarity.COMMON, color: '#4b69ff', image: IMG_EVIL_CUB },
        // Rare
        { id: 'e_space', name: 'Space Travel', price: 15400, rarity: Rarity.RARE, color: '#8847ff', image: IMG_EVIL_SPACE },
        { id: 'e_rally', name: 'Market Rally', price: 22500, rarity: Rarity.RARE, color: '#8847ff', image: IMG_EVIL_RALLY },
        { id: 'e_riot', name: 'Riot Pack', price: 28900, rarity: Rarity.RARE, color: '#8847ff', image: IMG_EVIL_RIOT },
        // Epic
        { id: 'e_neptune', name: 'Neptune', price: 42000, rarity: Rarity.EPIC, color: '#d32ce6', image: IMG_EVIL_NEPTUNE },
        { id: 'e_turtles', name: 'Turtles', price: 85000, rarity: Rarity.EPIC, color: '#d32ce6', image: IMG_EVIL_TURTLES },
        // Legendary
        { id: 'e_frog', name: 'Gummy Frog', price: 65000, rarity: Rarity.LEGENDARY, color: '#e4ae39', image: IMG_EVIL_FROG },
        { id: 'e_elven', name: 'Elven Might', price: 180000, rarity: Rarity.LEGENDARY, color: '#eb4b4b', image: IMG_EVIL_ELVEN },
        { id: 'e_pepe', name: 'Raphael', price: 1500000, rarity: Rarity.LEGENDARY, color: '#e4ae39', image: IMG_EVIL_PEPE },
      ];

      const CASES = [
        {
          id: 'case_dervuz',
          name: 'dervuz',
          price: 4500, 
          image: IMG_CASE_1,
          contains: ['g_key', 'g_tg', 'g_cat', 'g_loot', 'g_salt', 'g_sign', 'g_capt', 'g_dip']
        },
        {
          id: 'case_pro',
          name: 'evilholic',
          price: 12000, 
          image: IMG_CASE_EVILHOLIC,
          contains: ['e_daytona', 'e_cub', 'e_space', 'e_rally', 'e_riot', 'e_neptune', 'e_frog', 'e_turtles', 'e_elven', 'e_pepe']
        },
        {
          id: 'case_elite',
          name: 'Dreams & Nightmares',
          price: 45000,
          image: IMG_CASE_3,
          contains: ['g_salt', 'g_sign', 'g_capt', 'g_dip']
        },
        {
          id: 'case_god',
          name: 'Cobblestone',
          price: 200000,
          image: IMG_CASE_4,
          contains: ['g_capt', 'g_dip']
        }
      ];

      // --- GAME LOGIC ---

      const ITEM_WEIGHTS = {
        // Case 1: Dervuz
        'g_dip': 1,      // Dipper: Very Rare (~0.01% in full pool)
        'g_capt': 10,    // Captain: Rare (~0.1%)
        'g_sign': 50,    // Westside: Epic (~0.5%)
        'g_salt': 50,    // Saltwater: Epic (~0.5%)
        'g_loot': 300,   // Loot Bag: Rare (~3%)
        'g_cat': 300,    // Cat: Rare (~3%)
        'g_tg': 4000,    // Telegram: Common (~40%)
        'g_key': 5289,   // Key: Common (~53%)

        // Case 2: Evilholic
        'e_pepe': 1,     // Pepe (Jackpot): 0.01%
        'e_frog': 1,     // Gummy Frog: Jackpot (~0.01%) - SAME AS RAPHAEL
        'e_elven': 10,   // Elven Might: 0.1%
        'e_turtles': 40, // Epics (~0.5%)
        'e_neptune': 40,
        'e_riot': 200,   // Rares (~2%)
        'e_rally': 200,
        'e_space': 200,
        'e_cub': 4000,   // Commons (~40%)
        'e_daytona': 5508
      };

      const getItemsFromCase = (gameCase) => {
        return gameCase.contains.map(id => ITEMS.find(i => i.id === id)).filter(Boolean);
      };

      const pickWeightedItem = (items) => {
        let totalWeight = 0;
        const weights = items.map(item => {
          const w = ITEM_WEIGHTS[item.id] || 100;
          totalWeight += w;
          return w;
        });
        let random = Math.random() * totalWeight;
        for (let i = 0; i < items.length; i++) {
          if (random < weights[i]) return items[i];
          random -= weights[i];
        }
        return items[0];
      };

      const openCaseLogic = (gameCase) => pickWeightedItem(getItemsFromCase(gameCase));

      const generateRouletteStrip = (gameCase, winner) => {
        const items = getItemsFromCase(gameCase);
        const strip = [];
        for (let i = 0; i < 50; i++) {
          strip.push(i === 45 ? winner : pickWeightedItem(items));
        }
        return strip;
      };

      const calculateUpgradeChance = (source, target) => {
        if (target <= source) return 95;
        return Math.min(Math.max((source / target) * 95, 1), 80);
      };

      const performCrafting = (ingredients) => {
        const totalValue = ingredients.reduce((sum, item) => sum + item.price, 0);
        const roll = Math.random() * 100;
        let multiplier = roll < 50 ? 0.5 + Math.random() * 0.5 :
                         roll < 85 ? 1.1 + Math.random() * 0.9 :
                         roll < 99 ? 2.0 + Math.random() * 3.0 : 5.0 + Math.random() * 5.0;
        const target = totalValue * multiplier;
        let closest = ITEMS[0], minDiff = Math.abs(target - ITEMS[0].price);
        ITEMS.forEach(item => {
          const diff = Math.abs(target - item.price);
          if (diff < minDiff) { minDiff = diff; closest = item; }
        });
        return closest;
      };

      const getRarityWeight = (rarity) => {
        if(rarity === Rarity.LEGENDARY) return 4;
        if(rarity === Rarity.EPIC) return 3;
        if(rarity === Rarity.RARE) return 2;
        return 1;
      };

      // --- COMPONENTS ---

      const StarIcon = ({ className }) => (
        <svg viewBox="0 0 24 24" fill="#EAB308" xmlns="http://www.w3.org/2000/svg" className={className || "w-4 h-4"} width="1em" height="1em">
          <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" stroke="#EAB308" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
        </svg>
      );

      const RARITY_COLOR_MAP = {
        [Rarity.COMMON]: '#3b82f6',
        [Rarity.RARE]: '#8b5cf6',
        [Rarity.EPIC]: '#ec4899',
        [Rarity.LEGENDARY]: '#ef4444',
      };

      const ItemCard = ({ item, onClick, isSelected, showPrice = true, compact = false }) => {
        const displayColor = item.color || RARITY_COLOR_MAP[item.rarity];
        return (
          <div onClick={onClick} className={`relative overflow-hidden flex flex-col ${compact ? 'rounded-[16px] h-[140px]' : 'rounded-[20px] h-[200px]'} bg-[#16161A] border ${isSelected ? 'border-yellow-500 ring-1 ring-yellow-500' : 'border-[#202026]'} cursor-pointer transition-all duration-200 select-none w-full`}>
            {item.isPinned && (
              <div className="absolute top-1 right-1 z-20 bg-[#26262B] text-gray-300 border border-[#3A3A40] rounded-full p-[5px] shadow-lg">
                 {/* Requested SVG for Pin */}
                 <svg width="10" height="10" viewBox="-2.4 -2.4 28.80 28.80" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path fillRule="evenodd" clipRule="evenodd" d="M17.1218 1.87023C15.7573 0.505682 13.4779 0.76575 12.4558 2.40261L9.61062 6.95916C9.61033 6.95965 9.60913 6.96167 9.6038 6.96549C9.59728 6.97016 9.58336 6.97822 9.56001 6.9848C9.50899 6.99916 9.44234 6.99805 9.38281 6.97599C8.41173 6.61599 6.74483 6.22052 5.01389 6.87251C4.08132 7.22378 3.61596 8.03222 3.56525 8.85243C3.51687 9.63502 3.83293 10.4395 4.41425 11.0208L7.94975 14.5563L1.26973 21.2363C0.879206 21.6269 0.879206 22.26 1.26973 22.6506C1.66025 23.0411 2.29342 23.0411 2.68394 22.6506L9.36397 15.9705L12.8995 19.5061C13.4808 20.0874 14.2853 20.4035 15.0679 20.3551C15.8881 20.3044 16.6966 19.839 17.0478 18.9065C17.6998 17.1755 17.3043 15.5086 16.9444 14.5375C16.9223 14.478 16.9212 14.4114 16.9355 14.3603C16.9421 14.337 16.9502 14.3231 16.9549 14.3165C16.9587 14.3112 16.9606 14.31 16.9611 14.3098L21.5177 11.4645C23.1546 10.4424 23.4147 8.16307 22.0501 6.79853L17.1218 1.87023ZM14.1523 3.46191C14.493 2.91629 15.2528 2.8296 15.7076 3.28445L20.6359 8.21274C21.0907 8.66759 21.0041 9.42737 20.4584 9.76806L15.9019 12.6133C14.9572 13.2032 14.7469 14.3637 15.0691 15.2327C15.3549 16.0037 15.5829 17.1217 15.1762 18.2015C15.1484 18.2752 15.1175 18.3018 15.0985 18.3149C15.0743 18.3316 15.0266 18.3538 14.9445 18.3589C14.767 18.3699 14.5135 18.2916 14.3137 18.0919L5.82846 9.6066C5.62872 9.40686 5.55046 9.15333 5.56144 8.97583C5.56651 8.8937 5.58877 8.84605 5.60548 8.82181C5.61855 8.80285 5.64516 8.7719 5.71886 8.74414C6.79869 8.33741 7.91661 8.56545 8.68762 8.85128C9.55668 9.17345 10.7171 8.96318 11.3071 8.01845L14.1523 3.46191Z" fill="currentColor"></path> 
                 </svg>
              </div>
            )}
            <div className="flex-1 bg-[#1D1D22] flex items-center justify-center relative p-2 overflow-hidden">
              <div className="absolute w-[120%] h-[120%] opacity-5 rounded-full blur-2xl" style={{ backgroundColor: displayColor }}></div>
              <img src={item.image} alt={item.name} referrerPolicy="no-referrer" className="w-[90%] h-[90%] object-contain relative z-10 drop-shadow-[0_5px_5px_rgba(0,0,0,0.5)]" draggable={false} />
            </div>
            <div className={`bg-[#141419] text-center w-full flex flex-col justify-center border-t border-[#202026] ${compact ? 'p-2 h-[45px]' : 'p-3 h-[60px]'}`}>
              <h3 className={`font-bold text-[#F2F2F4] truncate w-full ${compact ? 'text-[10px]' : 'text-[13px]'}`}>{item.name}</h3>
              {showPrice && (
                <div className={`flex items-center justify-center gap-1 font-bold text-gray-500 ${compact ? 'text-[9px]' : 'text-[11px]'}`}>
                  <StarIcon className={compact ? "w-3 h-3" : "w-3.5 h-3.5"} />
                  <span>{Math.floor(item.price).toLocaleString()}</span>
                </div>
              )}
            </div>
            <div className="h-[2px] w-full" style={{ backgroundColor: displayColor }}></div>
          </div>
        );
      };

      const BottomNav = ({ activeTab, onTabChange }) => {
        const navItems = [
          { 
            id: 'profile', label: 'Profile', 
            icon: <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="8" r="4" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/><path d="M20 21C20 18.2386 17.7614 15 15 15H9C6.23858 15 4 18.2386 4 21" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/></svg>
          },
          { 
            id: 'upgrade', label: 'Upgrade', 
            icon: <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 20V4" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/><path d="M5 11L12 4L19 11" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/></svg>
          },
          { 
            id: 'craft', label: 'Craft', 
            icon: <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M13.7 5.3L18.7 10.3L7 22L2 17L13.7 5.3Z" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/><path d="M17 2L22 7" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/><path d="M12.5 11.5L17.5 6.5" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/></svg>
          },
          { 
            id: 'home', label: 'Case', 
            icon: <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="9" width="18" height="12" rx="2" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/><path d="M12 9V21" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/><path d="M12 9L7.5 4.5C6.6 3.6 5.3 3.6 4.5 4.5C3.6 5.3 3.6 6.6 4.5 7.5L12 9Z" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/><path d="M12 9L16.5 4.5C17.3 3.6 18.6 3.6 19.5 4.5C20.3 5.3 20.3 6.6 19.5 7.5L12 9Z" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/></svg>
          }
        ];

        return (
          <div className="fixed bottom-0 left-0 w-full h-[78px] bg-[#101013] border-t border-[#1C1C20] flex justify-around items-center z-50 pb-2 max-w-[440px] left-1/2 -translate-x-1/2 shadow-none">
            {navItems.map((item) => (
              <button key={item.id} onClick={() => onTabChange(item.id)} className={`flex flex-col items-center transition-all duration-300 w-16 pt-2 ${activeTab === item.id ? 'opacity-100 -translate-y-[2px] text-white' : 'opacity-50 text-[#8E8E93]'}`}>
                <div className={`w-[26px] h-[26px] flex items-center justify-center mb-[4px] ${activeTab === item.id ? 'drop-shadow-[0_0_8px_rgba(255,255,255,0.2)]' : ''}`}>{item.icon}</div>
                <span className="text-[11px] font-semibold block tracking-wide">{item.label}</span>
              </button>
            ))}
          </div>
        );
      };

      const Roulette = ({ activeCase, winner, onClose, onComplete, onSell }) => {
        const [strip, setStrip] = useState([]);
        const [spinning, setSpinning] = useState(false);
        const [showResult, setShowResult] = useState(false);
        const scrollRef = useRef(null);

        const cardWidth = 150;
        const winnerIndex = 45;

        useEffect(() => {
          setStrip(generateRouletteStrip(activeCase, winner));
          const timer = setTimeout(() => setSpinning(true), 300);
          return () => clearTimeout(timer);
        }, [activeCase, winner]);

        useEffect(() => {
          if (spinning) {
            const targetTranslateX = (winnerIndex * cardWidth) + (cardWidth / 2);
            if (scrollRef.current) {
              scrollRef.current.style.transition = `transform 6500ms cubic-bezier(0.1, 0, 0.05, 1)`;
              scrollRef.current.style.transform = `translateX(-${targetTranslateX}px)`;
            }
            const endTimer = setTimeout(() => { setShowResult(true); onComplete(); }, 7000);
            return () => clearTimeout(endTimer);
          }
        }, [spinning]);

        if (showResult) {
          return (
            <div className="fixed inset-0 z-[100] bg-black/80 backdrop-blur-xl flex flex-col items-center justify-center p-6 animate-fade-in max-w-[440px] mx-auto">
              <div className="text-center mb-8">
                <div className="text-[#F5F5F7] font-bold text-lg opacity-70 mb-2">YOU WON</div>
                <h2 className={`text-3xl font-bold uppercase tracking-wider ${winner.rarity === Rarity.LEGENDARY ? 'text-red-500' : winner.rarity === Rarity.EPIC ? 'text-pink-500' : winner.rarity === Rarity.RARE ? 'text-purple-500' : 'text-blue-500'}`}>{winner.name}</h2>
              </div>
              <div className="w-64 transform scale-110 mb-10"><ItemCard item={winner} isSelected showPrice /></div>
              <div className="flex flex-col w-full gap-3 max-w-xs">
                <button onClick={onClose} className="w-full py-4 bg-[#F5F5F7] text-black font-bold rounded-[16px] text-[15px] flex items-center justify-center leading-none">KEEP ITEM</button>
                <button onClick={onSell} className="w-full py-4 bg-[#1C1C21] text-[#F5F5F7] border border-[#26262B] font-bold rounded-[16px] text-[15px] flex items-center justify-center gap-2 leading-none">SELL FOR <StarIcon /> {winner.price.toFixed(0)}</button>
              </div>
            </div>
          );
        }

        return (
          <div className="fixed inset-0 z-[100] flex flex-col bg-black/60 backdrop-blur-md max-w-[440px] mx-auto">
            <div className="h-[60px] flex items-center justify-center bg-transparent border-b border-white/10"><span className="font-bold text-[#F5F5F7]">Opening Case...</span></div>
            <div className="flex-1 flex items-center relative overflow-hidden" style={{ maskImage: 'linear-gradient(to right, transparent, black 15%, black 85%, transparent)', WebkitMaskImage: 'linear-gradient(to right, transparent, black 15%, black 85%, transparent)' }}>
              <div className="absolute left-1/2 top-0 bottom-0 w-[2px] bg-[#EAB308] z-20 transform -translate-x-1/2 shadow-[0_0_15px_#EAB308]"></div>
              <div ref={scrollRef} className="flex items-center px-[50vw]">{strip.map((item, i) => <div key={i} className="w-[150px] px-1 flex-shrink-0"><ItemCard item={item} compact showPrice={false} /></div>)}</div>
            </div>
            <div className="h-[120px] bg-transparent border-t border-white/10 flex items-center justify-center"><div className="text-gray-300 animate-pulse">Rolling...</div></div>
          </div>
        );
      };

      const Upgrade = ({ userState, onUpgradeSuccess, onUpgradeFail }) => {
        const [selectedInventoryItem, setInvItem] = useState(null);
        const [selectedTargetItem, setTargetItem] = useState(null);
        const [isRolling, setIsRolling] = useState(false);
        const [animateSuccess, setSuccess] = useState(false);

        const availableTargets = useMemo(() => {
          if (!selectedInventoryItem) return ITEMS;
          return ITEMS.filter(i => i.price > selectedInventoryItem.price).sort((a,b) => a.price - b.price);
        }, [selectedInventoryItem]);

        const winChance = useMemo(() => selectedInventoryItem && selectedTargetItem ? calculateUpgradeChance(selectedInventoryItem.price, selectedTargetItem.price) : 0, [selectedInventoryItem, selectedTargetItem]);

        const handleUpgrade = () => {
          if (!selectedInventoryItem || !selectedTargetItem || isRolling) return;
          setIsRolling(true);
          setTimeout(() => {
            if (Math.random() * 100 <= winChance) {
              setSuccess(true);
              setTimeout(() => { onUpgradeSuccess(selectedInventoryItem, selectedTargetItem); setIsRolling(false); setSuccess(false); setInvItem(null); setTargetItem(null); }, 800);
            } else {
              onUpgradeFail(selectedInventoryItem);
              setIsRolling(false); setInvItem(null); setTargetItem(null);
            }
          }, 2000);
        };

        return (
          <div className="flex flex-col h-full">
            <h2 className="text-center text-[20px] font-bold text-[#E4E4E8] mb-[20px]">UPGRADE</h2>
            <div className="bg-[#16161A] border border-[#202026] rounded-[20px] p-4 mb-6">
              <div className="flex items-center justify-between">
                <div onClick={() => !isRolling && setInvItem(null)} className={`w-[100px] h-[100px] border border-dashed border-[#26262B] rounded-[16px] flex items-center justify-center bg-[#1A1A1F] overflow-hidden transition-all ${animateSuccess ? 'upgrade-fade-out' : ''}`}>
                  {selectedInventoryItem ? <div className="w-full h-full p-1"><ItemCard item={selectedInventoryItem} compact showPrice={false} /></div> : <span className="text-gray-600">+</span>}
                </div>
                <div className="relative w-20 h-20 flex items-center justify-center">
                  <svg className="w-full h-full rotate-[-90deg]" viewBox="0 0 36 36"><path className="text-[#26262B]" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" strokeWidth="3"/><path className={isRolling ? 'text-[#EAB308] animate-spin origin-center' : 'text-blue-500'} strokeDasharray={`${winChance}, 100`} d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" strokeWidth="3" style={{transition:'stroke-dasharray 0.5s ease'}}/></svg>
                  <div className="absolute font-bold text-sm text-[#F5F5F7]">{winChance.toFixed(1)}%</div>
                </div>
                <div onClick={() => !isRolling && setTargetItem(null)} className={`w-[100px] h-[100px] border border-dashed border-[#26262B] rounded-[16px] flex items-center justify-center bg-[#1A1A1F] overflow-hidden transition-all ${animateSuccess ? 'upgrade-success-pop border-yellow-500 border-solid' : ''}`}>
                  {selectedTargetItem ? <div className="w-full h-full p-1"><ItemCard item={selectedTargetItem} compact showPrice={false} /></div> : <span className="text-gray-600">+</span>}
                </div>
              </div>
              <button disabled={!selectedInventoryItem || !selectedTargetItem || isRolling} onClick={handleUpgrade} className={`w-full mt-6 py-3 rounded-[16px] font-bold text-[14px] transition-all flex items-center justify-center leading-none ${!selectedInventoryItem || !selectedTargetItem || isRolling ? 'bg-[#1F1F24] text-gray-500' : 'bg-[#F5F5F7] text-black'}`}>{isRolling ? 'ROLLING...' : 'UPGRADE'}</button>
            </div>
            <div className="flex-1">
              <div className="text-xs font-bold text-gray-500 mb-3 uppercase tracking-wider px-1">{!selectedInventoryItem ? 'Select Item' : 'Select Target'}</div>
              <div className="grid grid-cols-3 gap-[10px]">{!selectedInventoryItem ? userState.inventory.map((item, i) => <div key={i} onClick={() => setInvItem(item)}><ItemCard item={item} compact showPrice /></div>) : availableTargets.map((item, i) => <div key={i} onClick={() => setTargetItem(item)}><ItemCard item={item} compact showPrice /></div>)}</div>
            </div>
          </div>
        );
      };

      const Craft = ({ userState, onCraftSuccess }) => {
        const [selected, setSelected] = useState([]);
        const [isCrafting, setCrafting] = useState(false);
        const [result, setResult] = useState(null);
        const [selectedIndices, setIndices] = useState([]);

        const toggle = (item, idx) => {
          if (isCrafting) return;
          if (selectedIndices.includes(idx)) {
            setIndices(p => p.filter(i => i !== idx));
            const s = [...selected]; s.splice(selected.findIndex(i => i.id === item.id), 1); setSelected(s);
          } else {
            if (selected.length >= 10) return;
            setIndices(p => [...p, idx]); setSelected(p => [...p, item]);
          }
        };

        const removeFromSlot = (idx) => {
           if (isCrafting) return;
           const item = selected[idx];
           const s = [...selected]; s.splice(idx, 1); setSelected(s);
           const invIdx = selectedIndices.find(i => userState.inventory[i].id === item.id);
           if (invIdx !== undefined) setIndices(p => p.filter(i => i !== invIdx));
        };

        const doCraft = () => {
          if (selected.length < 5) return;
          setCrafting(true);
          setTimeout(() => {
            const r = performCrafting(selected);
            setResult(r);
            setTimeout(() => { onCraftSuccess(selected, r); setCrafting(false); setSelected([]); setIndices([]); }, 2000);
          }, 2000);
        };

        return (
          <div className="pb-20">
             <h2 className="text-center text-xl font-bold text-gray-200 mb-5">CRAFTING</h2>
             <div className="px-4 mb-6"><div className="bg-[#16161A] border border-[#202026] rounded-3xl p-4">
               <div className="flex justify-between items-center mb-4"><span className="text-xs font-bold text-gray-500 uppercase tracking-wider">SLOTS ({selected.length}/10)</span><div className="flex items-center gap-1 text-yellow-500 font-bold text-sm"><span>Total:</span><StarIcon /><span>{selected.reduce((a,b)=>a+b.price,0).toLocaleString()}</span></div></div>
               <div className="grid grid-cols-5 gap-1.5 mb-6">{Array.from({length:10}).map((_,i) => <div key={i} onClick={() => selected[i] && removeFromSlot(i)} className={`aspect-square rounded-xl border flex items-center justify-center relative overflow-hidden ${selected[i] ? 'bg-[#1D1D22] border-[#26262B]' : 'bg-[#1A1A1F] border-[#202026] border-dashed'}`}>{selected[i] ? <img src={selected[i].image} className="w-4/5 h-4/5 object-contain" referrerPolicy="no-referrer"/> : <span className="text-[#26262B] font-bold text-xs">{i+1}</span>}</div>)}</div>
               <button disabled={selected.length < 5 || isCrafting} onClick={doCraft} className={`w-full py-4 rounded-2xl font-bold flex items-center justify-center gap-2 leading-none ${selected.length < 5 || isCrafting ? 'bg-[#1F1F24] text-gray-500' : 'bg-[#F5F5F7] text-black'}`}>{isCrafting ? 'CRAFTING...' : 'CRAFT ITEMS'}</button>
               <div className="text-center mt-2 text-[10px] text-gray-600">Min 5 items required</div>
             </div></div>
             <div className="px-4">
                <div className="text-xs font-bold text-gray-500 mb-3 uppercase tracking-wider px-1">Inventory</div>
                <div className="grid grid-cols-3 gap-[10px] pb-24">{userState.inventory.map((item, i) => <div key={i} onClick={() => toggle(item, i)} className={`relative transition-all ${selectedIndices.includes(i) ? 'opacity-40 scale-95 grayscale' : ''}`}><ItemCard item={item} compact showPrice />{selectedIndices.includes(i) && <div className="absolute inset-0 flex items-center justify-center"><div className="w-6 h-6 bg-white rounded-full flex items-center justify-center">✓</div></div>}</div>)}</div>
             </div>
             {result && <div className="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-6 backdrop-blur-md max-w-[440px] mx-auto"><div className="flex flex-col items-center w-full max-w-sm"><div className="text-yellow-500 text-xl font-bold mb-2">SUCCESS!</div><div className="scale-125 mb-10"><ItemCard item={result} isSelected showPrice /></div><button onClick={() => setResult(null)} className="w-full py-4 bg-white text-black font-bold rounded-2xl flex items-center justify-center leading-none">COLLECT</button></div></div>}
          </div>
        );
      };

      const App = () => {
        const [activeTab, setActiveTab] = useState('home');
        const [user, setUser] = useState({ id: '123', username: '@guest', firstName: 'Guest', lastName: '', balance: 50000, inventory: [], xp: 0, level: 1, avatarUrl: '' });
        const [friend, setFriend] = useState(null);
        const [selCase, setSelCase] = useState(null);
        const [qty, setQty] = useState(1);
        const [actCase, setActCase] = useState(null);
        const [win, setWin] = useState(null);
        const [bulk, setBulk] = useState([]);
        const [showBulk, setShowBulk] = useState(false);
        const [menuData, setMenuData] = useState(null);
        const [sellData, setSellData] = useState(null);

        useEffect(() => {
            // Initialize Telegram WebApp
            if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                tg.ready();
                tg.expand();
                
                // Set theme params
                try {
                    tg.setHeaderColor('#0D0D10'); 
                    tg.setBackgroundColor('#0D0D10'); 
                } catch (e) {}

                // Extract User Data strictly from initDataUnsafe
                const tgUser = tg.initDataUnsafe?.user;
                
                if (tgUser) {
                    setUser(prev => ({
                        ...prev,
                        id: tgUser.id.toString(),
                        username: tgUser.username ? '@' + tgUser.username : 'Hidden',
                        firstName: tgUser.first_name,
                        lastName: tgUser.last_name || '',
                        avatarUrl: tgUser.photo_url // Telegram Avatar URL
                    }));
                }

                // Handle params for friend link
                const params = new URLSearchParams(window.location.search);
                const uid = params.get('uid') || tg.initDataUnsafe?.start_param;
                
                if (uid && tgUser && uid !== tgUser.id.toString()) {
                   setFriend({ id: uid, username: '@visitor', firstName: 'Visitor', lastName:'', balance: 0, inventory: [ITEMS[7], ITEMS[0]], xp: 1000, level: 5, avatarUrl: '' });
                   setActiveTab('profile');
                }
            }
        }, []);

        const displayUser = friend || user;
        const isOwn = !friend;
        const fullName = `${displayUser.firstName} ${displayUser.lastName}`.trim();
        const xpPct = Math.min((displayUser.xp / (displayUser.level * 5000)) * 100, 100);

        const buyCase = () => {
          if (user.balance < selCase.price * qty) return alert("Insufficient Funds");
          setUser(u => ({ ...u, balance: u.balance - (selCase.price * qty) }));
          const wins = [];
          for(let i=0; i<qty; i++) wins.push({ ...openCaseLogic(selCase), isPinned: false });
          
          if(qty === 1) { setWin(wins[0]); setActCase(selCase); setSelCase(null); }
          else {
            setBulk(wins);
            setUser(u => ({ ...u, inventory: [...wins, ...u.inventory], xp: u.xp + wins.reduce((a,b)=>a+b.price*0.1,0) }));
            setShowBulk(true); setSelCase(null);
          }
        };

        const finishRoulette = () => {
          if(win) setUser(u => ({ ...u, inventory: [{...win, isPinned: false}, ...u.inventory], xp: u.xp + win.price * 0.1 }));
        };
        
        const sellRoulette = () => {
          if(win) {
             setUser(u => {
               const inv = [...u.inventory]; inv.shift(); 
               return { ...u, balance: u.balance + win.price, inventory: inv };
             });
             setActCase(null); setWin(null);
          }
        };

        const togglePin = () => {
          if(!menuData) return;
          const idx = menuData.index;
          const newInv = [...user.inventory];
          if(newInv[idx].isPinned) newInv[idx].isPinned = false;
          else {
             if(newInv.filter(i=>i.isPinned).length >= 6) return alert("Max 6 pins");
             newInv[idx].isPinned = true;
          }
          setUser(u => ({ ...u, inventory: newInv }));
          setMenuData(null);
        };

        const sellItem = () => {
           const idx = sellData.index;
           const newInv = [...user.inventory];
           newInv.splice(idx, 1);
           setUser(u => ({ ...u, inventory: newInv, balance: u.balance + (sellData.item.price * 0.8) }));
           setSellData(null);
        };

        const sortedInv = displayUser.inventory.map((item, i) => ({ item, i }));
        if(isOwn) sortedInv.sort((a,b) => (b.item.isPinned === a.item.isPinned) ? 0 : b.item.isPinned ? 1 : -1);

        return (
          <div className="min-h-screen bg-[#0D0D10] max-w-[440px] mx-auto relative shadow-2xl" style={{ paddingTop: 'calc(20px + env(safe-area-inset-top))' }}>
             <header className="mx-5 mb-5 p-4 bg-[#141418] border border-[#1F1F24] rounded-3xl flex justify-between items-center">
               <div className="flex items-center gap-3">
                 <div className="w-14 h-14 rounded-2xl bg-[#1C1C21] border border-[#222227] overflow-hidden flex items-center justify-center">
                    {displayUser.avatarUrl ? <img src={displayUser.avatarUrl} className="w-full h-full object-cover"/> : <span className="text-gray-500 text-xs">{displayUser.firstName.charAt(0)}</span>}
                 </div>
                 <div className="flex items-center"><div className="text-lg font-bold text-[#F0F0F2] truncate max-w-[100px]">{displayUser.firstName}</div></div>
               </div>
               <div onClick={() => isOwn && setUser(u=>({...u, balance: u.balance+5000}))} className="flex items-center gap-2 bg-[#1A1A1F] border border-[#26262B] rounded-2xl py-3 px-5"><span className="font-bold text-[#F5F5F7]">{Math.floor(displayUser.balance).toLocaleString()}</span><StarIcon className="w-5 h-5"/></div>
             </header>
             <div className="w-full h-[1px] bg-[#19191D] my-5"></div>
             <div className="animate-fade-in pb-24">
                {activeTab === 'home' && (
                  <>
                    <h2 className="text-center text-xl font-bold text-gray-200 mb-5">AVAILABLE CASES</h2>
                    <div className="grid grid-cols-2 gap-4 px-5">
                      {CASES.map(c => (
                        <div key={c.id} onClick={() => { setSelCase(c); setQty(1); }} className="bg-[#16161A] border border-[#202026] rounded-[24px] h-[220px] overflow-hidden flex flex-col relative group cursor-pointer hover:border-gray-500 transition-colors">
                           <div className="h-[150px] bg-[#1D1D22] flex-shrink-0 flex items-center justify-center p-4 w-full">
                              <img src={c.image} className="w-full h-full object-contain drop-shadow-xl transition-transform duration-300 group-active:scale-95" referrerPolicy="no-referrer"/>
                           </div>
                           <div className="h-[70px] flex-shrink-0 w-full bg-[#141419] flex flex-col items-center justify-center border-t border-[#202026]">
                              <div className="text-[15px] font-bold text-[#F2F2F4] mb-1 truncate max-w-[90%] capitalize text-center w-full">{c.name}</div>
                              <div className="inline-flex items-center gap-1.5 bg-[#1A1A1F] px-3 py-1 rounded-lg border border-[#26262B]">
                                 <StarIcon className="w-3.5 h-3.5 text-[#EAB308]"/>
                                 <span className="text-[12px] font-bold text-gray-400 leading-none pt-[1px]">{c.price.toLocaleString()}</span>
                              </div>
                           </div>
                        </div>
                      ))}
                    </div>
                  </>
                )}
                {activeTab === 'upgrade' && <div className="px-5"><Upgrade userState={user} onUpgradeSuccess={(o, n) => { const inv=[...user.inventory]; inv[user.inventory.findIndex(i=>i.id===o.id)]={...n, isPinned:false}; setUser({...user, inventory: inv}); }} onUpgradeFail={(o) => { const inv=[...user.inventory]; inv.splice(user.inventory.findIndex(i=>i.id===o.id), 1); setUser({...user, inventory: inv}); }} /></div>}
                {activeTab === 'craft' && <Craft userState={user} onCraftSuccess={(ings, res) => { const inv=[...user.inventory]; ings.forEach(ing => { const idx=inv.findIndex(i=>i.id===ing.id); if(idx>-1) inv.splice(idx,1); }); inv.unshift({...res, isPinned:false}); setUser({...user, inventory:inv}); }} />}
                
                {activeTab === 'profile' && (
                  <div className="px-5 flex flex-col items-center pt-2">
                    {!isOwn && <button onClick={() => { setFriend(null); setActiveTab('home'); }} className="self-start mb-4 text-gray-500">Back</button>}
                    
                    {/* Avatar Block */}
                    <div className="w-24 h-24 bg-[#1C1C21] border border-[#222227] rounded-[30px] overflow-hidden mb-4 flex items-center justify-center">
                        {displayUser.avatarUrl ? <img src={displayUser.avatarUrl} className="w-full h-full object-cover"/> : <span className="text-gray-500 text-2xl">{displayUser.firstName.charAt(0)}</span>}
                    </div>
                    
                    <h2 className="text-2xl font-bold text-gray-100 mb-6">{fullName}</h2>
                    
                    {/* Telegram Info Block */}
                    <div className="w-full bg-[#16161A] border border-[#202026] rounded-3xl p-5 mb-6">
                        <div className="text-gray-500 text-[10px] font-bold uppercase tracking-wider mb-4">Information</div>
                        <div className="flex justify-between py-2 border-b border-[#202026] mb-2">
                            <span className="text-gray-200">Username</span>
                            <span className="text-blue-500">{displayUser.username}</span>
                        </div>
                        <div className="flex justify-between py-2">
                            <span className="text-gray-200">ID</span>
                            <span className="text-gray-500">{displayUser.id}</span>
                        </div>
                    </div>
                    
                    {isOwn && <button onClick={() => navigator.clipboard.writeText(`${window.location.origin}?uid=${displayUser.id}`).then(()=>alert('Copied!'))} className="w-full bg-[#1C1C21] border border-[#26262B] rounded-2xl py-4 mb-6 text-gray-100 font-bold text-sm flex items-center justify-center leading-none">Share Profile Link</button>}
                    <div className="w-full"><div className="flex justify-between mb-3"><span className="text-gray-500 text-[10px] font-bold uppercase tracking-wider px-1">Inventory</span></div>
                      <div className="grid grid-cols-3 gap-[10px]">{sortedInv.length === 0 ? <div className="col-span-3 text-center py-10 text-gray-600 text-sm">Empty</div> : sortedInv.map(({ item, i }) => <div key={i} onClick={() => isOwn && setMenuData({ item, index: i })}><ItemCard item={item} compact showPrice /></div>)}</div>
                    </div>
                  </div>
                )}
             </div>
             <BottomNav activeTab={activeTab} onTabChange={setActiveTab} />
             
             {/* Modals */}
             {selCase && (
               <div className="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-end justify-center max-w-[440px] mx-auto" onClick={() => setSelCase(null)}>
                 <div className="w-full bg-[#16161A] rounded-t-3xl p-6 flex flex-col items-center max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                   <h3 className="text-xl font-bold text-gray-100 mb-6">{selCase.name}</h3>
                   <div className="w-44 h-44 bg-[#1D1D22] rounded-3xl flex items-center justify-center mb-6 border border-[#202026]"><img src={selCase.image} className="w-4/5 h-4/5 object-contain"/></div>
                   <div className="flex gap-6 mb-8 items-center">
                     <button type="button" onClick={(e) => { e.stopPropagation(); setQty(Math.max(1, qty-1)); }} className="w-12 h-12 bg-[#202026] rounded-xl text-2xl font-bold flex items-center justify-center leading-none text-white">-</button>
                     <span className="text-2xl font-bold">{qty}</span>
                     <button type="button" onClick={(e) => { e.stopPropagation(); setQty(Math.min(10, qty+1)); }} className="w-12 h-12 bg-[#202026] rounded-xl text-2xl font-bold flex items-center justify-center leading-none text-white">+</button>
                   </div>
                   
                   {/* Standard Button Style */}
                   <button onClick={buyCase} className="w-full py-4 bg-[#F5F5F7] text-black font-bold rounded-2xl text-[16px] flex items-center justify-center gap-2 active:scale-95 transition-transform">
                     <span>Open for</span><StarIcon className="w-5 h-5 text-yellow-600"/><span>{(selCase.price*qty).toLocaleString()}</span>
                   </button>
                   
                   <div className="w-full mt-6"><div className="text-center text-gray-400 text-sm font-bold mb-4 uppercase">Подарки в кейсе</div><div className="grid grid-cols-4 gap-1">{getItemsFromCase(selCase).sort((a,b) => getRarityWeight(b.rarity) - getRarityWeight(a.rarity) || b.price - a.price).map((it, i) => <div key={i} className="flex flex-col items-center"><div className="w-[70px] h-[70px] bg-[#1D1D22] rounded-xl border border-[#26262B] flex items-center justify-center p-2 relative overflow-hidden"><div className="absolute inset-0 opacity-10" style={{backgroundColor:it.color}}></div><img src={it.image} className="w-full h-full object-contain relative z-10" referrerPolicy="no-referrer"/></div><span className="text-[9px] text-gray-400 mt-1 truncate w-full text-center">{it.name}</span></div>)}</div></div>
                 </div>
               </div>
             )}

             {showBulk && <div className="fixed inset-0 z-[70] bg-[#0D0D10] flex flex-col p-6 max-w-[440px] mx-auto"><h2 className="text-center text-2xl font-bold text-gray-200 mt-10 mb-6">YOU WON</h2><div className="flex-1 grid grid-cols-2 gap-4 content-start overflow-y-auto">{bulk.map((it, i) => <div key={i} className="animate-fade-in" style={{animationDelay: i*0.05+'s'}}><ItemCard item={it} showPrice/></div>)}</div><button onClick={() => { setShowBulk(false); setBulk([]); }} className="w-full bg-white text-black h-14 rounded-2xl font-bold mt-4 mb-10 flex items-center justify-center leading-none">COLLECT ALL</button></div>}

             {menuData && <div className="fixed inset-0 z-[80] bg-black/60 backdrop-blur-sm flex items-end justify-center max-w-[440px] mx-auto" onClick={() => setMenuData(null)}><div className="w-full bg-[#16161A] rounded-t-3xl p-6 flex flex-col items-center" onClick={e => e.stopPropagation()}><h3 className="text-lg font-bold text-gray-100 mb-4 text-center">{menuData.item.name}</h3><div className="mb-6 w-32"><ItemCard item={menuData.item} compact showPrice={false} isSelected /></div><div className="flex gap-3 w-full"><button onClick={togglePin} className="flex-1 py-4 bg-[#26262B] text-gray-100 font-bold rounded-2xl border border-[#333] flex justify-center items-center gap-2 leading-none">{menuData.item.isPinned ? 'Unpin' : 'Pin to Top'}  <svg width="16" height="16" viewBox="-2.4 -2.4 28.80 28.80" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" clipRule="evenodd" d="M17.1218 1.87023C15.7573 0.505682 13.4779 0.76575 12.4558 2.40261L9.61062 6.95916C9.61033 6.95965 9.60913 6.96167 9.6038 6.96549C9.59728 6.97016 9.58336 6.97822 9.56001 6.9848C9.50899 6.99916 9.44234 6.99805 9.38281 6.97599C8.41173 6.61599 6.74483 6.22052 5.01389 6.87251C4.08132 7.22378 3.61596 8.03222 3.56525 8.85243C3.51687 9.63502 3.83293 10.4395 4.41425 11.0208L7.94975 14.5563L1.26973 21.2363C0.879206 21.6269 0.879206 22.26 1.26973 22.6506C1.66025 23.0411 2.29342 23.0411 2.68394 22.6506L9.36397 15.9705L12.8995 19.5061C13.4808 20.0874 14.2853 20.4035 15.0679 20.3551C15.8881 20.3044 16.6966 19.839 17.0478 18.9065C17.6998 17.1755 17.3043 15.5086 16.9444 14.5375C16.9223 14.478 16.9212 14.4114 16.9355 14.3603C16.9421 14.337 16.9502 14.3231 16.9549 14.3165C16.9587 14.3112 16.9606 14.31 16.9611 14.3098L21.5177 11.4645C23.1546 10.4424 23.4147 8.16307 22.0501 6.79853L17.1218 1.87023ZM14.1523 3.46191C14.493 2.91629 15.2528 2.8296 15.7076 3.28445L20.6359 8.21274C21.0907 8.66759 21.0041 9.42737 20.4584 9.76806L15.9019 12.6133C14.9572 13.2032 14.7469 14.3637 15.0691 15.2327C15.3549 16.0037 15.5829 17.1217 15.1762 18.2015C15.1484 18.2752 15.1175 18.3018 15.0985 18.3149C15.0743 18.3316 15.0266 18.3538 14.9445 18.3589C14.767 18.3699 14.5135 18.2916 14.3137 18.0919L5.82846 9.6066C5.62872 9.40686 5.55046 9.15333 5.56144 8.97583C5.56651 8.8937 5.58877 8.84605 5.60548 8.82181C5.61855 8.80285 5.64516 8.7719 5.71886 8.74414C6.79869 8.33741 7.91661 8.56545 8.68762 8.85128C9.55668 9.17345 10.7171 8.96318 11.3071 8.01845L14.1523 3.46191Z" fill="currentColor"></path></svg></button><button onClick={() => { setSellData(menuData); setMenuData(null); }} className="flex-1 py-4 bg-white text-black font-bold rounded-2xl flex items-center justify-center leading-none">Sell</button></div><button onClick={() => setMenuData(null)} className="mt-4 text-gray-500 text-sm">Cancel</button></div></div>}

             {sellData && <div className="fixed inset-0 z-[90] bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 max-w-[440px] mx-auto"><div className="w-full max-w-xs bg-[#16161A] border border-[#202026] rounded-3xl p-6 flex flex-col items-center text-center"><h3 className="text-lg font-bold text-gray-100 mb-4">Sell Item?</h3><div className="mb-4 w-32"><ItemCard item={sellData.item} compact showPrice={false} isSelected /></div><div className="text-gray-400 text-sm mb-6">Receive <span className="text-yellow-500 font-bold">{(sellData.item.price*0.8).toLocaleString()}</span> stars.</div><div className="flex gap-3 w-full"><button onClick={() => setSellData(null)} className="flex-1 py-3 bg-[#1C1C21] text-gray-100 font-bold rounded-xl border border-[#26262B] flex items-center justify-center leading-none">Cancel</button><button onClick={sellItem} className="flex-1 py-3 bg-white text-black font-bold rounded-xl flex items-center justify-center leading-none">Confirm</button></div></div></div>}

             {actCase && win && <Roulette activeCase={actCase} winner={win} onClose={() => { setActCase(null); setWin(null); }} onComplete={finishRoulette} onSell={sellRoulette} />}
          </div>
        );
      };

      // --- INIT ---
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);

    </script>
  </body>
</html>
