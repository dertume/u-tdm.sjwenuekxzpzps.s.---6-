
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
    <title>Gifts Battle</title>
    
    <!-- External Libraries -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FIREBASE SDK (Compat version for simple HTML usage) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics-compat.js"></script>
    
    <!-- React 18 UMD -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Global Styles -->
    <style>
      :root {
        --bg-main: #0D0D10;
        --bg-card: #16161A;
        --text-main: #F5F5F7;
        --accent-gold: #EAB308;
      }

      body {
        background-color: var(--bg-main);
        color: var(--text-main);
        font-family: 'Inter', sans-serif;
        overscroll-behavior: none;
        padding-bottom: 0;
        -webkit-font-smoothing: antialiased;
        margin: 0;
        user-select: none;
        -webkit-user-select: none;
        -webkit-tap-highlight-color: transparent;
      }

      /* Hide scrollbar */
      ::-webkit-scrollbar { display: none; }
      * { -ms-overflow-style: none; scrollbar-width: none; }

      .animate-fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

      .upgrade-fade-out { opacity: 0; transform: scale(0.9); transition: all 0.6s ease-out; }
      .upgrade-success-pop { animation: popSuccess 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
      @keyframes popSuccess {
        0% { transform: scale(1); }
        50% { transform: scale(1.15); filter: brightness(1.2); }
        100% { transform: scale(1); filter: brightness(1); }
      }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
</head>
  <body>
    <div id="root"></div>

    <!-- Application Logic -->
    <script type="text/babel">
      const { useState, useEffect, useRef, useMemo, useCallback } = React;

      // --- FIREBASE CONFIG ---
      const firebaseConfig = {
        apiKey: "AIzaSyAcV5PlqC2EWymC17k5ogbAUU3Aq-W7iy8",
        authDomain: "base-79237.firebaseapp.com",
        projectId: "base-79237",
        storageBucket: "base-79237.firebasestorage.app",
        messagingSenderId: "580440878220",
        appId: "1:580440878220:web:3d7498f3018f6101039fa9",
        measurementId: "G-KSLE45ZPE2"
      };

      // Initialize Firebase
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      const db = firebase.firestore();
      const analytics = firebase.analytics();

      // --- CONSTANTS & CONFIG ---
      
      const Rarity = {
        COMMON: 'COMMON',
        RARE: 'RARE',
        EPIC: 'EPIC',
        LEGENDARY: 'LEGENDARY'
      };

      // Gift Images
      const IMG_GIFT_CAT = "https://i.ibb.co/NdXSDY0X/f2aa355890cc49b2b47c3fddde527bd5-Scared-Cat-Celestia.webp";
      const IMG_GIFT_SIGN = "https://i.ibb.co/C309w4MG/e70ef163ca8e4bbeb171c270ceeefd1a-Westside-Sign-Sapphire.webp";
      const IMG_GIFT_CAPTAIN = "https://i.ibb.co/21s07HnX/Captain.webp";
      const IMG_GIFT_SALTWATER = "https://i.ibb.co/TqRygLZD/Saltwater.webp";
      const IMG_GIFT_DIPPER = "https://i.ibb.co/KxTpL9pG/Dipper.webp";
      const IMG_GIFT_LOOTBAG = "https://i.ibb.co/RTHKf4fz/0a6cc79a0d11441aa93bde7c49e7f177-Loot-Bag-Courchevel.webp";
      const IMG_GIFT_TELEGRAM = "https://i.ibb.co/KpKTgrjC/Telegram.webp";
      const IMG_GIFT_VERIFICATION = "https://i.ibb.co/fGNJ2wxY/Input-Key-Verification-aaa.webp";

      // Evilholic Items
      const IMG_EVIL_DAYTONA = "https://i.ibb.co/sv6M8PZj/Blue-Daytona.webp";
      const IMG_EVIL_CUB = "https://i.ibb.co/fGGmJznh/Golden-Cub.webp";
      const IMG_EVIL_SPACE = "https://i.ibb.co/v4CJJW3C/Space-Travel.webp";
      const IMG_EVIL_RALLY = "https://i.ibb.co/TMCJ8Spj/Market-Rally.webp";
      const IMG_EVIL_RIOT = "https://i.ibb.co/Rk78wz2w/Riot-Pack.webp";
      const IMG_EVIL_NEPTUNE = "https://i.ibb.co/cXNMfLCL/Neptune.webp";
      const IMG_EVIL_FROG = "https://i.ibb.co/svRgz79x/Gummy-Frog.webp";
      const IMG_EVIL_TURTLES = "https://i.ibb.co/4ng79f3k/Turtles.webp";
      const IMG_EVIL_ELVEN = "https://i.ibb.co/F47mKRB3/Elven-Might.webp";
      const IMG_EVIL_PEPE = "https://i.ibb.co/nsN61dvy/65349e0f3a63466e9bbc363d7fba12cc-Plush-Pepe-Raphael.webp";

      // Cases
      const IMG_CASE_1 = "https://i.ibb.co/kszCsN2z/case1.png";
      const IMG_CASE_EVILHOLIC = "https://i.ibb.co/HDBsfG9m/Gemini-Generated-Image-bnrq5zbnrq5zbnrq.png";
      const IMG_CASE_3 = "https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXU5A1PIYQNqhpOSV-fRPasw8rsUFJ5KBFZv668FFU4naLOJzgUuYqxz4XZk_L1YO_UwGkG6sEp2rGY89n32wbsqkA6MDr2I46LMlh53L8yIqE/360fx360f";
      const IMG_CASE_4 = "https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXU5A1PIYQNqhpOSV-fRPasw8rsUFJ5KBFZv668FFYwnfKfcG9H69z5i4VZl_T2MbjUzmQFu8Ry3rnD8I2i0VDm-RVsMm-lLY6LMlh5P3fVwA/360fx360f";

      const ITEMS = [
        // Dervuz Items
        { id: 'g_key', name: 'Input-Key-Verification', price: 3584, rarity: Rarity.COMMON, color: '#4b69ff', image: IMG_GIFT_VERIFICATION },
        { id: 'g_tg', name: 'Telegram', price: 6928, rarity: Rarity.COMMON, color: '#4b69ff', image: IMG_GIFT_TELEGRAM },
        // Rare
        { id: 'g_cat', name: 'Scared Cat Celestia', price: 13125, rarity: Rarity.RARE, color: '#8847ff', image: IMG_GIFT_CAT },
        { id: 'g_loot', name: 'Loot-Bag-Courchevel', price: 29990, rarity: Rarity.RARE, color: '#8847ff', image: IMG_GIFT_LOOTBAG },
        // Epic
        { id: 'g_salt', name: 'Saltwater', price: 30731, rarity: Rarity.EPIC, color: '#d32ce6', image: IMG_GIFT_SALTWATER },
        { id: 'g_sign', name: 'Westside-Sign-Sapphire', price: 37943, rarity: Rarity.EPIC, color: '#d32ce6', image: IMG_GIFT_SIGN },
        // Legendary
        { id: 'g_capt', name: 'Captain', price: 179099, rarity: Rarity.LEGENDARY, color: '#eb4b4b', image: IMG_GIFT_CAPTAIN },
        { id: 'g_dip', name: 'Dipper', price: 1300765, rarity: Rarity.LEGENDARY, color: '#e4ae39', image: IMG_GIFT_DIPPER },

        // Evilholic Items
        { id: 'e_daytona', name: 'Blue Daytona', price: 4500, rarity: Rarity.COMMON, color: '#4b69ff', image: IMG_EVIL_DAYTONA },
        { id: 'e_cub', name: 'Golden Cub', price: 6200, rarity: Rarity.COMMON, color: '#4b69ff', image: IMG_EVIL_CUB },
        // Rare
        { id: 'e_space', name: 'Space Travel', price: 15400, rarity: Rarity.RARE, color: '#8847ff', image: IMG_EVIL_SPACE },
        { id: 'e_rally', name: 'Market Rally', price: 22500, rarity: Rarity.RARE, color: '#8847ff', image: IMG_EVIL_RALLY },
        { id: 'e_riot', name: 'Riot Pack', price: 28900, rarity: Rarity.RARE, color: '#8847ff', image: IMG_EVIL_RIOT },
        // Epic
        { id: 'e_neptune', name: 'Neptune', price: 42000, rarity: Rarity.EPIC, color: '#d32ce6', image: IMG_EVIL_NEPTUNE },
        { id: 'e_turtles', name: 'Turtles', price: 85000, rarity: Rarity.EPIC, color: '#d32ce6', image: IMG_EVIL_TURTLES },
        // Legendary
        { id: 'e_frog', name: 'Gummy Frog', price: 65000, rarity: Rarity.LEGENDARY, color: '#e4ae39', image: IMG_EVIL_FROG },
        { id: 'e_elven', name: 'Elven Might', price: 180000, rarity: Rarity.LEGENDARY, color: '#eb4b4b', image: IMG_EVIL_ELVEN },
        { id: 'e_pepe', name: 'Raphael', price: 1500000, rarity: Rarity.LEGENDARY, color: '#e4ae39', image: IMG_EVIL_PEPE },
      ];

      const CASES = [
        {
          id: 'case_dervuz',
          name: 'dervuz',
          price: 4500, 
          image: IMG_CASE_1,
          contains: ['g_key', 'g_tg', 'g_cat', 'g_loot', 'g_salt', 'g_sign', 'g_capt', 'g_dip']
        },
        {
          id: 'case_pro',
          name: 'evilholic',
          price: 12000, 
          image: IMG_CASE_EVILHOLIC,
          contains: ['e_daytona', 'e_cub', 'e_space', 'e_rally', 'e_riot', 'e_neptune', 'e_frog', 'e_turtles', 'e_elven', 'e_pepe']
        },
        {
          id: 'case_elite',
          name: 'Dreams & Nightmares',
          price: 45000,
          image: IMG_CASE_3,
          contains: ['g_salt', 'g_sign', 'g_capt', 'g_dip']
        },
        {
          id: 'case_god',
          name: 'Cobblestone',
          price: 200000,
          image: IMG_CASE_4,
          contains: ['g_capt', 'g_dip']
        }
      ];

      // --- GAME LOGIC ---

      const ITEM_WEIGHTS = {
        'g_dip': 1,      // Dipper: Very Rare
        'g_capt': 10,    // Captain: Rare
        'g_sign': 50,    // Westside: Epic
        'g_salt': 50,    // Saltwater: Epic
        'g_loot': 300,   // Loot Bag: Rare
        'g_cat': 300,    // Cat: Rare
        'g_tg': 4000,    // Telegram: Common
        'g_key': 5289,   // Key: Common

        'e_pepe': 1,     // Pepe (Jackpot)
        'e_frog': 1,     // Gummy Frog: Jackpot
        'e_elven': 10,   // Elven Might
        'e_turtles': 40, // Epics
        'e_neptune': 40,
        'e_riot': 200,   // Rares
        'e_rally': 200,
        'e_space': 200,
        'e_cub': 4000,   // Commons
        'e_daytona': 5508
      };

      const getItemsFromCase = (gameCase) => {
        return gameCase.contains.map(id => ITEMS.find(i => i.id === id)).filter(Boolean);
      };

      const pickWeightedItem = (items) => {
        let totalWeight = 0;
        const weights = items.map(item => {
          const w = ITEM_WEIGHTS[item.id] || 100;
          totalWeight += w;
          return w;
        });
        let random = Math.random() * totalWeight;
        for (let i = 0; i < items.length; i++) {
          if (random < weights[i]) return items[i];
          random -= weights[i];
        }
        return items[0];
      };

      const openCaseLogic = (gameCase) => pickWeightedItem(getItemsFromCase(gameCase));

      const generateRouletteStrip = (gameCase, winner) => {
        const items = getItemsFromCase(gameCase);
        const strip = [];
        for (let i = 0; i < 50; i++) strip.push(i === 45 ? winner : pickWeightedItem(items));
        return strip;
      };

      const calculateUpgradeChance = (source, target) => {
        if (target <= source) return 95;
        return Math.min(Math.max((source / target) * 95, 1), 80);
      };

      const performCrafting = (ingredients) => {
        const totalValue = ingredients.reduce((sum, item) => sum + item.price, 0);
        const roll = Math.random() * 100;
        let multiplier = roll < 50 ? 0.5 + Math.random() * 0.5 : roll < 85 ? 1.1 + Math.random() * 0.9 : roll < 99 ? 2.0 + Math.random() * 3.0 : 5.0 + Math.random() * 5.0;
        const target = totalValue * multiplier;
        let closest = ITEMS[0], minDiff = Math.abs(target - ITEMS[0].price);
        ITEMS.forEach(item => {
          const diff = Math.abs(target - item.price);
          if (diff < minDiff) { minDiff = diff; closest = item; }
        });
        return closest;
      };

      const getRarityWeight = (rarity) => {
        if(rarity === Rarity.LEGENDARY) return 4;
        if(rarity === Rarity.EPIC) return 3;
        if(rarity === Rarity.RARE) return 2;
        return 1;
      };

      // --- COMPONENTS ---

      const StarIcon = ({ className }) => (
        <img 
          src="https://starsov.com/images/star-two.svg" 
          className={`${className || "w-4 h-4"} object-contain block relative -top-[1.5px]`} 
          alt="star" 
          draggable="false" 
        />
      );

      const RARITY_COLOR_MAP = {
        [Rarity.COMMON]: '#3b82f6',
        [Rarity.RARE]: '#8b5cf6',
        [Rarity.EPIC]: '#ec4899',
        [Rarity.LEGENDARY]: '#ef4444',
      };

      const ItemCard = ({ item, onClick, isSelected, showPrice = true, compact = false }) => {
        const displayColor = item.color || RARITY_COLOR_MAP[item.rarity];
        return (
          <div onClick={onClick} className={`relative overflow-hidden flex flex-col ${compact ? 'rounded-[16px] h-[140px]' : 'rounded-[20px] h-[200px]'} bg-[#16161A] border ${isSelected ? 'border-yellow-500 ring-1 ring-yellow-500' : 'border-[#202026]'} cursor-pointer transition-all duration-200 select-none w-full`}>
            {item.isPinned && (
              <div className="absolute top-1 right-1 z-20 bg-[#26262B] text-gray-300 border border-[#3A3A40] rounded-full p-[5px] shadow-lg">
                <svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                   <path d="M17.1218 1.87023C15.7573 0.505682 13.4779 0.76575 12.4558 2.40261L9.61062 6.95916C9.61033 6.95965 9.60913 6.96167 9.6038 6.96549C9.59728 6.97016 9.58336 6.97822 9.56001 6.9848C9.50899 6.99916 9.44234 6.99805 9.38281 6.97599C8.41173 6.61599 6.74483 6.22052 5.01389 6.87251C4.08132 7.22378 3.61596 8.03222 3.56525 8.85243C3.51687 9.63502 3.83293 10.4395 4.41425 11.0208L7.94975 14.5563L1.26973 21.2363C0.879206 21.6269 0.879206 22.26 1.26973 22.6506C1.66025 23.0411 2.29342 23.0411 2.68394 22.6506L9.36397 15.9705L12.8995 19.5061C13.4808 20.0874 14.2853 20.4035 15.0679 20.3551C15.8881 20.3044 16.6966 19.839 17.0478 18.9065C17.6998 17.1755 17.3043 15.5086 16.9444 14.5375C16.9223 14.478 16.9212 14.4114 16.9355 14.3603C16.9421 14.337 16.9502 14.3231 16.9549 14.3165C16.9587 14.3112 16.9606 14.31 16.9611 14.3098L21.5177 11.4645C23.1546 10.4424 23.4147 8.16307 22.0501 6.79853L17.1218 1.87023ZM14.1523 3.46191C14.493 2.91629 15.2528 2.8296 15.7076 3.28445L20.6359 8.21274C21.0907 8.66759 21.0041 9.42737 20.4584 9.76806L15.9019 12.6133C14.9572 13.2032 14.7469 14.3637 15.0691 15.2327C15.3549 16.0037 15.5829 17.1217 15.1762 18.2015C15.1484 18.2752 15.1175 18.3018 15.0985 18.3149C15.0743 18.3316 15.0266 18.3538 14.9445 18.3589C14.767 18.3699 14.5135 18.2916 14.3137 18.0919L5.82846 9.6066C5.62872 9.40686 5.55046 9.15333 5.56144 8.97583C5.56651 8.8937 5.58877 8.84605 5.60548 8.82181C5.61855 8.80285 5.64516 8.7719 5.71886 8.74414C6.79869 8.33741 7.91661 8.56545 8.68762 8.85128C9.55668 9.17345 10.7171 8.96318 11.3071 8.01845L14.1523 3.46191Z" fill="#0F0F0F"></path>
                </svg>
              </div>
            )}
            <div className="flex-1 bg-[#1D1D22] flex items-center justify-center relative p-2 overflow-hidden">
              <div className="absolute w-[120%] h-[120%] opacity-5 rounded-full blur-2xl" style={{ backgroundColor: displayColor }}></div>
              <img src={item.image} alt={item.name} referrerPolicy="no-referrer" className="w-[90%] h-[90%] object-contain relative z-10 drop-shadow-[0_5px_5px_rgba(0,0,0,0.5)]" draggable={false} />
            </div>
            <div className={`bg-[#141419] text-center w-full flex flex-col justify-center border-t border-[#202026] ${compact ? 'p-2 h-[45px]' : 'p-3 h-[60px]'}`}>
              <h3 className={`font-bold text-[#F2F2F4] truncate w-full ${compact ? 'text-[10px]' : 'text-[13px]'}`}>{item.name}</h3>
              {showPrice && (
                <div className={`flex items-center justify-center gap-1 font-bold text-gray-500 ${compact ? 'text-[9px]' : 'text-[11px]'}`}>
                  <span className="leading-none">{Math.floor(item.price).toLocaleString()}</span>
                  <StarIcon className={compact ? "w-3 h-3" : "w-3.5 h-3.5"} />
                </div>
              )}
            </div>
            <div className="h-[2px] w-full" style={{ backgroundColor: displayColor }}></div>
          </div>
        );
      };

      const BottomNav = ({ activeTab, onTabChange, hasNotifications }) => {
        const navItems = [
          { 
            id: 'profile', label: 'Profile', 
            icon: <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="8" r="4" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/><path d="M20 21C20 18.2386 17.7614 15 15 15H9C6.23858 15 4 18.2386 4 21" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/></svg>
          },
          { 
            id: 'upgrade', label: 'Upgrade', 
            icon: <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 20V4" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/><path d="M5 11L12 4L19 11" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/></svg>
          },
          { 
            id: 'exchange', label: 'Exchange',
            icon: (
              <div className="relative">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M7 10h14l-4-4"/><path d="M17 14H3l4 4"/></svg>
                {hasNotifications && <div className="absolute -top-1 -right-1 w-2.5 h-2.5 bg-red-500 rounded-full border border-[#101013]"></div>}
              </div>
            )
          },
          { 
            id: 'craft', label: 'Craft', 
            icon: <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M13.7 5.3L18.7 10.3L7 22L2 17L13.7 5.3Z" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/><path d="M17 2L22 7" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/><path d="M12.5 11.5L17.5 6.5" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/></svg>
          },
          { 
            id: 'home', label: 'Case', 
            icon: <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="9" width="18" height="12" rx="2" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/><path d="M12 9V21" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/><path d="M12 9L7.5 4.5C6.6 3.6 5.3 3.6 4.5 4.5C3.6 5.3 3.6 6.6 4.5 7.5L12 9Z" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/><path d="M12 9L16.5 4.5C17.3 3.6 18.6 3.6 19.5 4.5C20.3 5.3 20.3 6.6 19.5 7.5L12 9Z" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/></svg>
          },
        ];

        return (
          <div className="fixed bottom-0 left-0 w-full h-[78px] bg-[#101013] border-t border-[#1C1C20] flex justify-around items-center z-50 shadow-none pb-2">
            {navItems.map((item) => {
              const isActive = activeTab === item.id;
              return (
                <button
                  key={item.id}
                  onClick={() => onTabChange(item.id)}
                  className={`flex flex-col items-center transition-all duration-300 w-16 pt-2 ${isActive ? 'opacity-100 -translate-y-[2px] text-white' : 'opacity-50 text-[#8E8E93]'}`}
                >
                  <div className={`w-[26px] h-[26px] flex items-center justify-center mb-[4px] ${isActive ? 'drop-shadow-[0_0_8px_rgba(255,255,255,0.2)]' : ''}`}>
                       {item.icon}
                  </div>
                  <span className="text-[11px] font-semibold block tracking-wide">{item.label}</span>
                </button>
              );
            })}
          </div>
        );
      };

      const Roulette = ({ activeCase, winner, onClose, onComplete, onSell }) => {
        const [strip, setStrip] = useState([]);
        const [spinning, setSpinning] = useState(false);
        const [showResult, setShowResult] = useState(false);
        const scrollRef = useRef(null);
        
        const cardWidth = 150; 
        const winnerIndex = 45; 

        useEffect(() => {
          setStrip(generateRouletteStrip(activeCase, winner));
          const timer = setTimeout(() => setSpinning(true), 300);
          return () => clearTimeout(timer);
        }, [activeCase, winner]);

        useEffect(() => {
          if (spinning && scrollRef.current) {
            const spinDuration = 6500; 
            const targetTranslateX = (winnerIndex * cardWidth) + (cardWidth / 2);
            scrollRef.current.style.transition = `transform ${spinDuration}ms cubic-bezier(0.1, 0, 0.05, 1)`;
            scrollRef.current.style.transform = `translateX(-${targetTranslateX}px)`;

            const endTimer = setTimeout(() => {
              setShowResult(true);
              onComplete();
            }, spinDuration + 500); 
            return () => clearTimeout(endTimer);
          }
        }, [spinning]);

        if (showResult) {
          return (
            <div className="fixed inset-0 z-[100] bg-black/80 backdrop-blur-xl flex flex-col items-center justify-center p-6 animate-fade-in">
              <div className="text-center mb-8">
                  <div className="text-[#F5F5F7] font-bold text-lg opacity-70 mb-2">YOU WON</div>
                  <h2 className="text-3xl font-bold uppercase tracking-wider text-white">{winner.name}</h2>
              </div>
              <div className="w-64 transform scale-110 mb-10"><ItemCard item={winner} isSelected={true} showPrice={true} /></div>
              <div className="flex flex-col w-full gap-3 max-w-xs">
                <button onClick={onClose} className="w-full py-4 bg-[#F5F5F7] text-black font-bold rounded-[16px] text-[15px] hover:bg-white transition-colors">KEEP ITEM</button>
                <button onClick={onSell} className="w-full py-4 bg-[#1C1C21] text-[#F5F5F7] border border-[#26262B] font-bold rounded-[16px] text-[15px] hover:bg-[#222227] transition-colors flex items-center justify-center gap-2">
                  <span>SELL FOR</span><span className="leading-none">{winner.price.toFixed(0)}</span><StarIcon className="w-4 h-4" />
                </button>
              </div>
            </div>
          );
        }

        return (
          <div className="fixed inset-0 z-[100] flex flex-col bg-black/60 backdrop-blur-md">
            <div className="h-[60px] flex items-center justify-center border-b border-white/10 bg-transparent"><span className="font-bold text-[#F5F5F7] drop-shadow-md">Opening Case...</span></div>
            <div className="flex-1 flex items-center relative overflow-hidden" style={{ maskImage: 'linear-gradient(to right, transparent 0%, black 15%, black 85%, transparent 100%)', WebkitMaskImage: 'linear-gradient(to right, transparent 0%, black 15%, black 85%, transparent 100%)' }}>
              <div className="absolute left-1/2 top-0 bottom-0 w-[2px] bg-[#EAB308] z-20 transform -translate-x-1/2 shadow-[0_0_15px_#EAB308]"></div>
              <div ref={scrollRef} className="flex items-center px-[50vw] will-change-transform">{strip.map((item, idx) => (<div key={`${item.id}-${idx}`} className="w-[150px] px-1 flex-shrink-0"><ItemCard item={item} compact={true} showPrice={false} /></div>))}</div>
            </div>
          </div>
        );
      };

      const Upgrade = ({ userState, onUpgradeSuccess, onUpgradeFail }) => {
        const [selectedInventoryItem, setSelectedInventoryItem] = useState(null);
        const [selectedTargetItem, setSelectedTargetItem] = useState(null);
        const [isRolling, setIsRolling] = useState(false);
        const [spinAngle, setSpinAngle] = useState(0);

        const availableTargets = useMemo(() => {
          if (!selectedInventoryItem) return ITEMS.filter(i => i.price > 0);
          return ITEMS.filter(i => i.price > selectedInventoryItem.price).sort((a, b) => a.price - b.price);
        }, [selectedInventoryItem]);

        const winChance = useMemo(() => {
          if (!selectedInventoryItem || !selectedTargetItem) return 0;
          return calculateUpgradeChance(selectedInventoryItem.price, selectedTargetItem.price);
        }, [selectedInventoryItem, selectedTargetItem]);

        const handleUpgrade = () => {
          if (!selectedInventoryItem || !selectedTargetItem || isRolling) return;
          setIsRolling(true);

          const roll = Math.random() * 100;
          const success = roll <= winChance;
          
          const randomWin = Math.random() * winChance;
          const randomLoss = winChance + (Math.random() * (100 - winChance));
          
          const finalAngle = success ? randomWin : randomLoss;
          
          const totalRotations = 1800; // 5 spins
          const targetRotation = totalRotations + (finalAngle * 3.6); // Convert % to degrees

          setSpinAngle(targetRotation);

          setTimeout(() => {
            if (success) {
              onUpgradeSuccess(selectedInventoryItem, selectedTargetItem);
            } else {
              onUpgradeFail(selectedInventoryItem);
            }
            setIsRolling(false);
            setSpinAngle(0);
            setSelectedInventoryItem(null);
            setSelectedTargetItem(null);
          }, 3500);
        };

        return (
          <div className="flex flex-col h-full">
            <h2 className="text-center text-[20px] font-bold text-[#E4E4E8] mb-[20px]">UPGRADE</h2>
            <div className="bg-[#16161A] border border-[#202026] rounded-[20px] p-4 mb-6 shadow-none">
              <div className="flex items-center justify-between">
                <div className="w-[100px] h-[100px] border border-dashed border-[#26262B] rounded-[16px] flex items-center justify-center bg-[#1A1A1F] overflow-hidden" onClick={() => !isRolling && setSelectedInventoryItem(null)}>
                   {selectedInventoryItem ? <div className="w-full h-full p-1"><ItemCard item={selectedInventoryItem} compact showPrice={false} /></div> : <span className="text-gray-600 text-xs">SOURCE</span>}
                </div>

                <div className="relative w-28 h-28 flex items-center justify-center">
                   {/* Wheel Background */}
                   <svg className="w-full h-full rotate-[-90deg]" viewBox="0 0 36 36">
                     <circle cx="18" cy="18" r="15.9155" fill="none" stroke="#26262B" strokeWidth="4" />
                     {/* Win Zone (Yellow) */}
                     <circle cx="18" cy="18" r="15.9155" fill="none" stroke="#EAB308" strokeWidth="4" strokeDasharray={`${winChance}, 100`} />
                   </svg>
                   {/* Needle */}
                   <div 
                      className="absolute inset-0 flex items-center justify-center" 
                      style={{ 
                        transform: `rotate(${spinAngle}deg)`, 
                        transition: isRolling ? 'transform 3s cubic-bezier(0.1, 0, 0.1, 1)' : 'none' 
                      }}
                   >
                       <svg width="40" height="40" viewBox="0 0 24 24" fill="none" className="drop-shadow-lg">
                          <path d="M12 2L15 12L12 22L9 12L12 2Z" fill="white"/>
                          <circle cx="12" cy="12" r="2" fill="#0D0D10"/>
                       </svg>
                   </div>
                   <div className="absolute top-[105%] font-bold text-[#F5F5F7] text-sm">{winChance.toFixed(0)}%</div>
                </div>

                <div className="w-[100px] h-[100px] border border-dashed border-[#26262B] rounded-[16px] flex items-center justify-center bg-[#1A1A1F] overflow-hidden" onClick={() => !isRolling && setSelectedTargetItem(null)}>
                   {selectedTargetItem ? <div className="w-full h-full p-1"><ItemCard item={selectedTargetItem} compact showPrice={false} /></div> : <span className="text-gray-600 text-xs">TARGET</span>}
                </div>
              </div>
              <button disabled={!selectedInventoryItem || !selectedTargetItem || isRolling} onClick={handleUpgrade} className={`w-full mt-8 py-3 rounded-[16px] font-bold text-[14px] transition-all ${(!selectedInventoryItem || !selectedTargetItem || isRolling) ? 'bg-[#1F1F24] text-gray-500' : 'bg-[#F5F5F7] text-black hover:bg-white'}`}>{isRolling ? 'ROLLING...' : 'UPGRADE'}</button>
            </div>
            <div className="flex-1">
                <div className="grid grid-cols-3 gap-[10px]">
                   {!selectedInventoryItem ? userState.inventory.map((item, idx) => (<div key={idx} onClick={() => setSelectedInventoryItem(item)}><ItemCard item={item} compact showPrice /></div>)) : availableTargets.map((item, idx) => (<div key={idx} onClick={() => setSelectedTargetItem(item)}><ItemCard item={item} compact showPrice /></div>))}
                </div>
            </div>
          </div>
        );
      };

      const Craft = ({ userState, onCraftSuccess }) => {
        const [selectedItems, setSelectedItems] = useState([]);
        const [isCrafting, setIsCrafting] = useState(false);
        const [craftResult, setCraftResult] = useState(null);
        const [showResult, setShowResult] = useState(false);
        const [selectedIndices, setSelectedIndices] = useState([]);
        const totalValue = selectedItems.reduce((acc, item) => acc + item.price, 0);

        const toggleSelection = (item, index) => {
          if (isCrafting) return;
          if (selectedIndices.includes(index)) {
            setSelectedIndices(prev => prev.filter(i => i !== index));
            const itemIndexInSelected = selectedItems.findIndex(i => i.id === item.id);
            if (itemIndexInSelected > -1) {
               const newSelected = [...selectedItems];
               newSelected.splice(itemIndexInSelected, 1);
               setSelectedItems(newSelected);
            }
          } else {
            if (selectedItems.length >= 10) return;
            setSelectedIndices(prev => [...prev, index]);
            setSelectedItems(prev => [...prev, item]);
          }
        };

        const handleCraft = () => {
          if (selectedItems.length < 5) return;
          setIsCrafting(true);
          setTimeout(() => {
            const result = performCrafting(selectedItems);
            setCraftResult(result);
            setShowResult(true);
            setTimeout(() => {
                onCraftSuccess(selectedItems, result);
                setIsCrafting(false);
                setSelectedItems([]);
                setSelectedIndices([]);
            }, 2000); 
          }, 2000); 
        };

        return (
          <div className="pb-[20px]">
            <h2 className="text-center text-[20px] font-bold text-[#E4E4E8] mb-[20px]">CRAFTING</h2>
            <div className="px-[18px] mb-6">
              <div className="bg-[#16161A] border border-[#202026] rounded-[24px] p-4">
                  <div className="flex justify-between items-center mb-4"><span className="text-xs font-bold text-gray-500 uppercase">Slots ({selectedItems.length}/10)</span><div className="flex items-center gap-1 text-[#EAB308] font-bold text-sm"><span>Total:</span><span className="leading-none">{totalValue.toLocaleString()}</span><StarIcon /></div></div>
                  <div className="grid grid-cols-5 gap-2 mb-6">{Array.from({ length: 10 }).map((_, i) => (<div key={i} className={`aspect-square rounded-[12px] border flex items-center justify-center overflow-hidden relative ${selectedItems[i] ? 'bg-[#1D1D22] border-[#26262B]' : 'bg-[#1A1A1F] border-[#202026] border-dashed'}`}>{selectedItems[i] ? <img src={selectedItems[i].image} className="w-[80%] h-[80%] object-contain" referrerPolicy="no-referrer" /> : <span className="text-[#26262B] text-xs font-bold">{i + 1}</span>}</div>))}</div>
                  <button disabled={selectedItems.length < 5 || isCrafting} onClick={handleCraft} className={`w-full py-4 rounded-[18px] font-bold text-[16px] flex items-center justify-center gap-2 transition-all ${selectedItems.length < 5 ? 'bg-[#1F1F24] text-gray-500' : 'bg-[#F5F5F7] text-black'}`}>{isCrafting ? 'CRAFTING...' : 'CRAFT ITEMS'}</button>
              </div>
            </div>
            <div className="px-[18px]">
               <div className="text-xs font-bold text-gray-500 mb-3 uppercase">Select Ingredients</div>
               <div className="grid grid-cols-3 gap-[10px] pb-24">{userState.inventory.map((item, idx) => (<div key={idx} onClick={() => toggleSelection(item, idx)} className={`relative transition-all duration-200 ${selectedIndices.includes(idx) ? 'opacity-40 scale-95 grayscale' : ''}`}><ItemCard item={item} compact showPrice />{selectedIndices.includes(idx) && <div className="absolute inset-0 flex items-center justify-center"><div className="w-6 h-6 bg-[#F5F5F7] rounded-full flex items-center justify-center">âœ“</div></div>}</div>))}</div>
            </div>
            {showResult && craftResult && (<div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-md animate-fade-in p-6"><div className="flex flex-col items-center w-full max-w-sm"><div className="text-[#EAB308] font-bold text-xl mb-2 animate-bounce">SUCCESS!</div><div className="transform scale-125 mb-10"><ItemCard item={craftResult} isSelected showPrice /></div><button onClick={() => {setShowResult(false); setCraftResult(null);}} className="w-full py-4 bg-[#F5F5F7] text-black font-bold rounded-[18px]">COLLECT</button></div></div>)}
          </div>
        );
      };
      
      const Exchange = ({ userState, setUserState, hasNotifications }) => {
        const [mode, setMode] = useState('search'); 
        const [searchQuery, setSearchQuery] = useState('');
        const [targetUser, setTargetUser] = useState(null);
        
        const [myOffer, setMyOffer] = useState([]);
        const [theirOffer, setTheirOffer] = useState([]);
        
        const handleSearch = async () => {
            if (!searchQuery) return;
            try {
                // Search users in Firestore
                // Firestore doesn't support LIKE %query%. We use prefix search for username.
                // We strip '@' because we assume usernames are stored without it or we query consistently.
                const cleanQuery = searchQuery.replace('@', '');
                
                const q = db.collection("users")
                    .where('username', '>=', '@' + cleanQuery)
                    .where('username', '<=', '@' + cleanQuery + '\uf8ff')
                    .limit(1);

                const querySnapshot = await q.get();
                
                if (!querySnapshot.empty) {
                    const userData = querySnapshot.docs[0].data();
                    // Inventory comes from Firestore as an array, no JSON.parse needed unless legacy
                    setTargetUser({ ...userData, telegramId: querySnapshot.docs[0].id });
                } else {
                    alert('User not found in database');
                    setTargetUser(null);
                }
            } catch (e) {
                console.error(e);
                alert("Search failed or user not found");
            }
        };

        const toggleMyItem = (item, idx) => {
            if (myOffer.includes(idx)) setMyOffer(prev => prev.filter(i => i !== idx));
            else setMyOffer(prev => [...prev, idx]);
        };

        const sendTrade = async () => {
             if (!targetUser) return;
             
             const trade = {
                 id: Date.now().toString(),
                 fromId: userState.id, 
                 fromName: userState.username,
                 toId: targetUser.telegramId, 
                 toName: targetUser.username,
                 status: 'pending',
                 offeredItems: myOffer.map(idx => userState.inventory[idx]),
                 requestedItems: [] 
             };
             
             alert(`Trade sent to ${targetUser.username}! (Database update required for real-time delivery)`);
             
             // Update local state, actual realtime requires Firestore listeners
             setUserState(prev => ({
                 ...prev,
                 trades: [...(prev.trades || []), trade]
             }));
             
             setTargetUser(null);
             setMyOffer([]);
        };
        
        const cancelTrade = (tradeId) => {
            setUserState(prev => ({
                ...prev,
                trades: prev.trades.filter(t => t.id !== tradeId)
            }));
        };

        return (
           <div className="pb-24 px-4">
              <div className="flex justify-center gap-4 mb-6">
                 <button onClick={() => setMode('search')} className={`pb-2 font-bold ${mode === 'search' ? 'text-white border-b-2 border-[#EAB308]' : 'text-gray-500'}`}>Search</button>
                 <button onClick={() => setMode('requests')} className={`pb-2 font-bold relative ${mode === 'requests' ? 'text-white border-b-2 border-[#EAB308]' : 'text-gray-500'}`}>
                    Requests
                    {hasNotifications && <div className="absolute top-0 -right-2 w-2 h-2 bg-red-500 rounded-full"></div>}
                 </button>
              </div>

              {mode === 'search' && (
                 <div>
                    <div className="flex gap-2 mb-6">
                       <input 
                         value={searchQuery}
                         onChange={(e) => setSearchQuery(e.target.value)}
                         placeholder="Enter username (e.g. @username)"
                         className="flex-1 bg-[#16161A] border border-[#26262B] rounded-[16px] px-4 text-white focus:outline-none focus:border-[#EAB308]"
                       />
                       <button onClick={handleSearch} className="bg-[#F5F5F7] text-black px-6 rounded-[16px] font-bold">Find</button>
                    </div>
                    
                    {targetUser && (
                       <div className="bg-[#16161A] border border-[#202026] rounded-[24px] p-4 animate-fade-in">
                          <div className="flex items-center gap-4 mb-4">
                             <div className="w-12 h-12 bg-[#26262B] rounded-full overflow-hidden">
                                {targetUser.avatarUrl && <img src={targetUser.avatarUrl} className="w-full h-full" />}
                             </div>
                             <div>
                                <div className="font-bold text-white">{targetUser.firstName}</div>
                                <div className="text-xs text-blue-400">{targetUser.username}</div>
                             </div>
                          </div>
                          
                          <div className="text-xs font-bold text-gray-500 uppercase mb-2">Your Offer</div>
                          <div className="grid grid-cols-4 gap-2 mb-4 max-h-40 overflow-y-auto">
                              {userState.inventory.map((item, idx) => (
                                 <div key={idx} onClick={() => toggleMyItem(item, idx)} className={`relative ${myOffer.includes(idx) ? 'ring-2 ring-[#EAB308] rounded-[12px]' : 'opacity-60'}`}>
                                    <ItemCard item={item} compact showPrice={false} />
                                 </div>
                              ))}
                          </div>
                          
                          <button onClick={sendTrade} className="w-full py-3 bg-[#EAB308] text-black font-bold rounded-[16px]">SEND TRADE REQUEST</button>
                       </div>
                    )}
                 </div>
              )}

              {mode === 'requests' && (
                 <div className="flex flex-col gap-4">
                    <h3 className="text-gray-500 text-xs font-bold uppercase">Incoming</h3>
                    {userState.trades?.filter(t => t.toId === userState.id).length === 0 && <div className="text-gray-600 text-sm">No incoming requests</div>}
                    
                    <h3 className="text-gray-500 text-xs font-bold uppercase mt-4">Sent</h3>
                    {userState.trades?.filter(t => t.fromId === userState.id).map(trade => (
                        <div key={trade.id} className="bg-[#16161A] p-4 rounded-[16px] border border-[#202026]">
                            <div className="flex justify-between mb-2">
                                <span className="text-sm font-bold">To: {trade.toName}</span>
                                <span className="text-xs text-yellow-500 uppercase">{trade.status}</span>
                            </div>
                            <div className="flex gap-2 mb-3">
                                {trade.offeredItems.map((item, i) => (
                                    <div key={i} className="w-10 h-10 bg-[#1D1D22] rounded border border-[#26262B] p-1"><img src={item.image} className="w-full h-full object-contain"/></div>
                                ))}
                            </div>
                            <button onClick={() => cancelTrade(trade.id)} className="w-full py-2 bg-[#26262B] text-white text-xs font-bold rounded-[12px]">CANCEL</button>
                        </div>
                    ))}
                    {userState.trades?.filter(t => t.fromId === userState.id).length === 0 && <div className="text-gray-600 text-sm">No sent requests</div>}
                 </div>
              )}
           </div>
        );
      };

      const App = () => {
        const [activeTab, setActiveTab] = useState('home');
        const [isLoading, setIsLoading] = useState(true);
        const [userState, setUserState] = useState({
          id: '1234567',
          username: '@guest',
          firstName: 'Guest',
          lastName: '',
          balance: 50000,
          inventory: [],
          xp: 0,
          level: 1,
          trades: [] 
        });
        
        const saveTimeoutRef = useRef(null);

        // Load Data from Firestore
        const loadUserData = async (telegramId, tgUser) => {
            try {
                const docRef = db.collection("users").doc(telegramId);
                const docSnap = await docRef.get();

                if (docSnap.exists) {
                    const remoteUser = docSnap.data();
                    setUserState({
                        id: telegramId,
                        username: tgUser.username ? `@${tgUser.username}` : remoteUser.username,
                        firstName: tgUser.first_name || remoteUser.firstName,
                        lastName: tgUser.last_name || '',
                        balance: remoteUser.balance !== undefined ? remoteUser.balance : 50000,
                        inventory: remoteUser.inventory || [],
                        trades: remoteUser.trades || [],
                        xp: remoteUser.xp || 0,
                        level: remoteUser.level || 1,
                        avatarUrl: tgUser.photo_url
                    });
                } else {
                    // Create new user in Firestore
                    const newUser = {
                        telegramId: telegramId,
                        username: tgUser.username ? `@${tgUser.username}` : 'NoUser',
                        firstName: tgUser.first_name || 'Guest',
                        balance: 50000,
                        inventory: [],
                        trades: [],
                        xp: 0,
                        level: 1
                    };
                    await docRef.set(newUser);
                    
                    setUserState({
                        ...newUser,
                        id: telegramId,
                        avatarUrl: tgUser.photo_url
                    });
                }
            } catch (error) {
                console.error("Firestore Load Error:", error);
            } finally {
                setIsLoading(false);
            }
        };

        // Save Data to Firestore (Debounced)
        const saveUserData = useCallback((newState) => {
            if (!newState.id || newState.id === '1234567') return; // Don't save guest state

            if (saveTimeoutRef.current) clearTimeout(saveTimeoutRef.current);
            
            saveTimeoutRef.current = setTimeout(async () => {
                try {
                    await db.collection("users").doc(newState.id).set({
                        balance: newState.balance,
                        inventory: newState.inventory,
                        trades: newState.trades,
                        xp: newState.xp,
                        level: newState.level,
                        username: newState.username, // Keep username updated for search
                        firstName: newState.firstName
                    }, { merge: true });
                    console.log("Saved to Firestore");
                } catch (e) {
                    console.error("Save failed", e);
                }
            }, 1000); 
        }, []);

        useEffect(() => {
            if (!isLoading && userState.id !== '1234567') {
                saveUserData(userState);
            }
        }, [userState.balance, userState.inventory, userState.trades, userState.xp, userState.level, saveUserData, isLoading, userState.id]);

        useEffect(() => {
          const tg = window.Telegram?.WebApp;
          if (tg) {
            tg.ready();
            tg.expand();
            const user = tg.initDataUnsafe?.user;
            if (user) {
                loadUserData(user.id.toString(), user);
            } else {
                setIsLoading(false); 
            }
          } else {
             setIsLoading(false);
          }
        }, []);

        const [selectedCase, setSelectedCase] = useState(null);
        const [openQuantity, setOpenQuantity] = useState(1);
        const [rouletteActive, setRouletteActive] = useState(false);
        const [rouletteWinner, setRouletteWinner] = useState(null);
        const [bulkResult, setBulkResult] = useState(null);
        const [sellModal, setSellModal] = useState(null);
        const [actionModal, setActionModal] = useState(null);
        const [adminModal, setAdminModal] = useState(false);
        const [rawDbJson, setRawDbJson] = useState('');

        if (isLoading) {
            return <div className="min-h-screen bg-[#0D0D10] flex items-center justify-center text-white">Loading Profile...</div>;
        }

        const handleBuyCase = () => {
            const cost = selectedCase.price * openQuantity;
            if (userState.balance < cost) { alert("Insufficient funds"); return; }
            
            const wonItems = [];
            for(let i=0; i<openQuantity; i++) wonItems.push({ ...openCaseLogic(selectedCase), isPinned: false });
            
            if(openQuantity === 1) {
                setUserState(prev => ({ ...prev, balance: prev.balance - cost }));
                setRouletteWinner(wonItems[0]);
                setRouletteActive(true);
                setSelectedCase(null);
            } else {
                setUserState(prev => ({ 
                    ...prev, 
                    balance: prev.balance - cost, 
                    inventory: [...wonItems, ...prev.inventory]
                }));
                setBulkResult(wonItems);
                setSelectedCase(null);
            }
        };

        const handleRouletteComplete = () => {
             setUserState(prev => ({
                 ...prev,
                 inventory: [{ ...rouletteWinner, isPinned: false }, ...prev.inventory]
             }));
        };
        
        const handleRouletteSell = () => {
             setUserState(prev => {
                 const inv = [...prev.inventory];
                 if(inv[0].id === rouletteWinner.id) inv.shift(); 
                 return { ...prev, balance: prev.balance + rouletteWinner.price, inventory: inv };
             });
             setRouletteActive(false);
             setRouletteWinner(null);
        };

        const isAdmin = userState.username === '@evilholic';
        const openAdmin = () => {
            setRawDbJson(JSON.stringify(userState, null, 2));
            setAdminModal(true);
        };
        const adminGiveItem = (itemId) => {
            const item = ITEMS.find(i => i.id === itemId);
            if(item) {
                setUserState(prev => ({ ...prev, inventory: [{...item}, ...prev.inventory] }));
                alert(`Gave ${item.name}`);
            }
        };
        const saveRawDb = () => {
            try {
                const parsed = JSON.parse(rawDbJson);
                setUserState(prev => ({ ...prev, ...parsed }));
                setAdminModal(false);
            } catch(e) { alert("Invalid JSON"); }
        };

        return (
          <div className="min-h-screen bg-[#0D0D10] pb-20" style={{ paddingTop: 'calc(20px + env(safe-area-inset-top))' }}>
            <div className="mx-[18px] mb-[18px] p-[18px] bg-[#141418] border border-[#1F1F24] rounded-[22px] flex justify-between items-center">
               <div className="flex items-center gap-3">
                  <div className="w-[56px] h-[56px] bg-[#1C1C21] rounded-[18px] overflow-hidden">
                      {userState.avatarUrl ? <img src={userState.avatarUrl} className="w-full h-full object-cover"/> : <div className="w-full h-full flex items-center justify-center text-gray-500">?</div>}
                  </div>
                  <div>
                      <div className="text-[18px] font-bold text-white leading-tight">{userState.firstName}</div>
                      <div className="text-xs text-gray-500 font-medium">@{userState.username.replace('@','')}</div>
                  </div>
               </div>
               <div className="flex items-center gap-2 bg-[#1A1A1F] border border-[#26262B] rounded-[16px] px-4 py-3">
                   <span className="text-[15px] font-bold text-white leading-none">{Math.floor(userState.balance).toLocaleString()}</span>
                   <StarIcon className="w-5 h-5"/>
               </div>
            </div>

            <div className="animate-fade-in">
               {activeTab === 'home' && (
                  <div className="px-[18px]">
                     <h2 className="text-center text-[20px] font-bold text-[#E4E4E8] mb-4">AVAILABLE CASES</h2>
                     <div className="grid grid-cols-2 gap-[14px]">
                        {CASES.map(c => (
                            <div key={c.id} onClick={() => { setSelectedCase(c); setOpenQuantity(1); }} className="bg-[#16161A] border border-[#202026] rounded-[20px] h-[220px] flex flex-col overflow-hidden cursor-pointer">
                                <div className="h-[150px] bg-[#1D1D22] flex items-center justify-center p-2"><img src={c.image} className="h-full object-contain drop-shadow-lg" /></div>
                                <div className="h-[70px] bg-[#141419] flex flex-col items-center justify-center p-2">
                                    <div className="text-[15px] font-bold text-white capitalize">{c.name}</div>
                                    <div className="flex items-center gap-1 mt-1 bg-[#1F1F24] px-2 py-1 rounded-full"><span className="text-[13px] font-bold text-gray-400 leading-none">{c.price.toLocaleString()}</span><StarIcon className="w-3 h-3"/></div>
                                </div>
                            </div>
                        ))}
                     </div>
                  </div>
               )}

               {activeTab === 'upgrade' && (
                  <div className="px-[18px]">
                     <Upgrade 
                        userState={userState} 
                        onUpgradeSuccess={(oldI, newI) => {
                            const idx = userState.inventory.findIndex(i => i.id === oldI.id);
                            if(idx > -1) {
                                const inv = [...userState.inventory];
                                inv[idx] = { ...newI, isPinned: false };
                                setUserState(p => ({ ...p, inventory: inv }));
                            }
                        }} 
                        onUpgradeFail={(oldI) => {
                            const idx = userState.inventory.findIndex(i => i.id === oldI.id);
                            if(idx > -1) {
                                const inv = [...userState.inventory];
                                inv.splice(idx, 1);
                                setUserState(p => ({ ...p, inventory: inv }));
                            }
                        }} 
                     />
                  </div>
               )}

               {activeTab === 'exchange' && (
                   <Exchange userState={userState} setUserState={setUserState} hasNotifications={userState.trades?.some(t => t.toId === userState.id)} />
               )}

               {activeTab === 'craft' && (
                  <Craft 
                     userState={userState} 
                     onCraftSuccess={(ingreds, result) => {
                         const inv = [...userState.inventory];
                         ingreds.forEach(ing => {
                             const idx = inv.findIndex(i => i.id === ing.id);
                             if(idx > -1) inv.splice(idx, 1);
                         });
                         setUserState(p => ({ ...p, inventory: [{...result}, ...inv] }));
                     }} 
                  />
               )}

               {activeTab === 'profile' && (
                   <div className="px-[18px] flex flex-col items-center">
                       {isAdmin && <button onClick={openAdmin} className="self-end text-xs bg-red-900 text-red-200 px-2 py-1 rounded mb-2">ADMIN</button>}
                       <div className="w-[100px] h-[100px] rounded-[30px] bg-[#1C1C21] overflow-hidden mb-4 border border-[#222227]">{userState.avatarUrl ? <img src={userState.avatarUrl} className="w-full h-full object-cover"/> : null}</div>
                       <h2 className="text-[24px] font-bold text-white mb-6">{userState.firstName} {userState.lastName}</h2>
                       
                       <div className="w-full bg-[#16161A] border border-[#202026] rounded-[22px] p-5 mb-6">
                           <div className="text-gray-500 text-[11px] font-bold uppercase mb-4 ml-1">Information</div>
                           <div className="flex justify-between py-2 border-b border-[#202026]/50 mb-2"><span className="text-white">Username</span><span className="text-blue-500">{userState.username}</span></div>
                           <div className="flex justify-between py-2"><span className="text-white">ID</span><span className="text-gray-500">{userState.id}</span></div>
                       </div>
                       
                       <button onClick={() => {
                           const link = `https://t.me/ErosChatsBot/app?startapp=${userState.id}`;
                           navigator.clipboard.writeText(link);
                           alert("Link copied!");
                       }} className="w-full bg-[#1C1C21] border border-[#26262B] rounded-[18px] py-4 mb-6 text-white font-bold flex items-center justify-center gap-2">
                           <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
                           Share Profile Link
                       </button>

                       <div className="w-full">
                           <div className="text-gray-500 text-[11px] font-bold uppercase mb-3 ml-1">Inventory</div>
                           <div className="grid grid-cols-3 gap-[10px]">
                               {userState.inventory.map((item, idx) => (
                                   <div key={idx} onClick={() => setActionModal({ item, index: idx })}><ItemCard item={item} compact showPrice /></div>
                               ))}
                           </div>
                       </div>
                   </div>
               )}
            </div>

            <BottomNav activeTab={activeTab} onTabChange={setActiveTab} hasNotifications={userState.trades?.some(t => t.toId === userState.id)} />

            {selectedCase && (
                <div className="fixed inset-0 z-[60] flex items-end justify-center bg-black/60 backdrop-blur-sm" onClick={() => setSelectedCase(null)}>
                    <div onClick={e => e.stopPropagation()} className="w-full bg-[#16161A] rounded-t-[30px] p-6 max-h-[90vh] overflow-y-auto border-t border-[#202026]">
                        <h3 className="text-[20px] font-bold text-white mb-6 text-center">{selectedCase.name}</h3>
                        <div className="flex justify-center mb-6"><div className="w-[180px] h-[180px] bg-[#1D1D22] rounded-[24px] p-4 flex items-center justify-center"><img src={selectedCase.image} className="max-h-full object-contain" /></div></div>
                        <div className="flex justify-center items-center gap-6 mb-8">
                            <button type="button" onClick={(e) => { e.stopPropagation(); setOpenQuantity(Math.max(1, openQuantity-1)); }} className="w-12 h-12 bg-[#202026] rounded-xl text-gray-400 font-bold text-2xl flex items-center justify-center">-</button>
                            <span className="text-2xl font-bold w-8 text-center">{openQuantity}</span>
                            <button type="button" onClick={(e) => { e.stopPropagation(); setOpenQuantity(Math.min(10, openQuantity+1)); }} className="w-12 h-12 bg-[#202026] rounded-xl text-gray-400 font-bold text-2xl flex items-center justify-center">+</button>
                        </div>
                        <button onClick={handleBuyCase} className="w-full bg-[#F5F5F7] text-black h-[54px] rounded-[16px] font-bold text-[16px] flex items-center justify-center gap-2 mb-6">
                            <span>Open for</span><span className="leading-none">{(selectedCase.price * openQuantity).toLocaleString()}</span><StarIcon className="w-4 h-4"/>
                        </button>
                        <div className="grid grid-cols-3 gap-1">
                            {getItemsFromCase(selectedCase).sort((a,b) => b.price - a.price).map((item, i) => (
                                <div key={i} className="flex flex-col items-center bg-[#1D1D22] p-1 rounded-lg border border-[#26262B]">
                                    <img src={item.image} className="w-12 h-12 object-contain" referrerPolicy="no-referrer"/>
                                    <div className="text-[9px] text-gray-400 truncate w-full text-center">{item.name}</div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            )}

            {rouletteActive && rouletteWinner && <Roulette activeCase={activeCase || CASES[0]} winner={rouletteWinner} onClose={() => { setRouletteActive(false); setRouletteWinner(null); }} onComplete={handleRouletteComplete} onSell={handleRouletteSell} />}

            {bulkResult && (
                <div className="fixed inset-0 z-[70] bg-[#0D0D10] flex flex-col p-6 animate-fade-in">
                    <h2 className="text-center text-2xl font-bold text-white mt-10 mb-6">YOU WON</h2>
                    <div className="flex-1 overflow-y-auto grid grid-cols-2 gap-4 content-start">
                        {bulkResult.map((item, i) => <div key={i}><ItemCard item={item} showPrice /></div>)}
                    </div>
                    <button onClick={() => setBulkResult(null)} className="w-full bg-[#F5F5F7] text-black h-[56px] rounded-[18px] font-bold mb-10">COLLECT ALL</button>
                </div>
            )}

            {actionModal && (
                <div className="fixed inset-0 z-[80] flex items-end justify-center bg-black/60 backdrop-blur-sm" onClick={() => setActionModal(null)}>
                    <div onClick={e => e.stopPropagation()} className="w-full bg-[#16161A] rounded-t-[30px] p-6 pb-8 flex flex-col items-center border-t border-[#202026]">
                        <h3 className="text-lg font-bold text-white mb-4">{actionModal.item.name}</h3>
                        <div className="w-[120px] mb-6"><ItemCard item={actionModal.item} compact showPrice={false} isSelected /></div>
                        <div className="flex gap-3 w-full">
                            <button onClick={() => {
                                const inv = [...userState.inventory];
                                inv[actionModal.index].isPinned = !inv[actionModal.index].isPinned;
                                setUserState(p => ({ ...p, inventory: inv }));
                                setActionModal(null);
                            }} className="flex-1 py-4 bg-[#26262B] text-white font-bold rounded-[18px] border border-[#333] flex justify-center gap-2">
                                {actionModal.item.isPinned ? 'Unpin' : 'Pin'} 
                                <svg width="16" height="16" viewBox="-2.4 -2.4 28.80 28.80" fill="white" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" clipRule="evenodd" d="M17.1218 1.87023C15.7573 0.505682 13.4779 0.76575 12.4558 2.40261L9.61062 6.95916C9.61033 6.95965 9.60913 6.96167 9.6038 6.96549C9.59728 6.97016 9.58336 6.97822 9.56001 6.9848C9.50899 6.99916 9.44234 6.99805 9.38281 6.97599C8.41173 6.61599 6.74483 6.22052 5.01389 6.87251C4.08132 7.22378 3.61596 8.03222 3.56525 8.85243C3.51687 9.63502 3.83293 10.4395 4.41425 11.0208L7.94975 14.5563L1.26973 21.2363C0.879206 21.6269 0.879206 22.26 1.26973 22.6506C1.66025 23.0411 2.29342 23.0411 2.68394 22.6506L9.36397 15.9705L12.8995 19.5061C13.4808 20.0874 14.2853 20.4035 15.0679 20.3551C15.8881 20.3044 16.6966 19.839 17.0478 18.9065C17.6998 17.1755 17.3043 15.5086 16.9444 14.5375C16.9223 14.478 16.9212 14.4114 16.9355 14.3603C16.9421 14.337 16.9502 14.3231 16.9549 14.3165C16.9587 14.3112 16.9606 14.31 16.9611 14.3098L21.5177 11.4645C23.1546 10.4424 23.4147 8.16307 22.0501 6.79853L17.1218 1.87023ZM14.1523 3.46191C14.493 2.91629 15.2528 2.8296 15.7076 3.28445L20.6359 8.21274C21.0907 8.66759 21.0041 9.42737 20.4584 9.76806L15.9019 12.6133C14.9572 13.2032 14.7469 14.3637 15.0691 15.2327C15.3549 16.0037 15.5829 17.1217 15.1762 18.2015C15.1484 18.2752 15.1175 18.3018 15.0985 18.3149C15.0743 18.3316 15.0266 18.3538 14.9445 18.3589C14.767 18.3699 14.5135 18.2916 14.3137 18.0919L5.82846 9.6066C5.62872 9.40686 5.55046 9.15333 5.56144 8.97583C5.56651 8.8937 5.58877 8.84605 5.60548 8.82181C5.61855 8.80285 5.64516 8.7719 5.71886 8.74414C6.79869 8.33741 7.91661 8.56545 8.68762 8.85128C9.55668 9.17345 10.7171 8.96318 11.3071 8.01845L14.1523 3.46191Z" fill="white"></path></svg>
                            </button>
                            <button onClick={() => setSellModal(actionModal)} className="flex-1 py-4 bg-[#F5F5F7] text-black font-bold rounded-[18px]">Sell</button>
                        </div>
                    </div>
                </div>
            )}

            {sellModal && (
                <div className="fixed inset-0 z-[90] flex items-center justify-center bg-black/70 backdrop-blur-sm" onClick={() => setSellModal(null)}>
                    <div onClick={e => e.stopPropagation()} className="bg-[#16161A] p-6 rounded-[24px] text-center border border-[#202026]">
                        <h3 className="text-lg font-bold text-white mb-4">Sell {sellModal.item.name}?</h3>
                        <div className="text-gray-400 mb-6 flex justify-center items-center gap-1">Receive <span className="text-[#EAB308] font-bold leading-none">{(sellModal.item.price * 0.8).toFixed(0)}</span><StarIcon className="w-4 h-4"/></div>
                        <div className="flex gap-3">
                            <button onClick={() => setSellModal(null)} className="flex-1 py-3 bg-[#1C1C21] text-white rounded-[14px] border border-[#26262B]">Cancel</button>
                            <button onClick={() => {
                                const inv = [...userState.inventory];
                                inv.splice(sellModal.index, 1);
                                setUserState(p => ({ ...p, balance: p.balance + (sellModal.item.price * 0.8), inventory: inv }));
                                setSellModal(null);
                                setActionModal(null);
                            }} className="flex-1 py-3 bg-[#F5F5F7] text-black font-bold rounded-[14px]">Confirm</button>
                        </div>
                    </div>
                </div>
            )}

            {adminModal && (
                <div className="fixed inset-0 z-[99] bg-black p-4 overflow-y-auto">
                    <h2 className="text-white font-bold text-xl mb-4">Admin Panel</h2>
                    <div className="mb-4">
                        <h3 className="text-gray-400 text-sm mb-2">Give Item</h3>
                        <select onChange={(e) => adminGiveItem(e.target.value)} className="w-full bg-[#1C1C21] text-white p-3 rounded">
                            <option value="">Select Item...</option>
                            {ITEMS.map(i => <option key={i.id} value={i.id}>{i.name} ({i.price})</option>)}
                        </select>
                    </div>
                    <div className="mb-4">
                        <h3 className="text-gray-400 text-sm mb-2">Raw DB Editor</h3>
                        <textarea value={rawDbJson} onChange={e => setRawDbJson(e.target.value)} className="w-full h-64 bg-[#1C1C21] text-xs text-green-400 font-mono p-2 rounded" />
                    </div>
                    <div className="flex gap-2">
                        <button onClick={saveRawDb} className="bg-green-600 text-white px-4 py-2 rounded">Save DB</button>
                        <button onClick={() => setAdminModal(false)} className="bg-gray-600 text-white px-4 py-2 rounded">Close</button>
                    </div>
                </div>
            )}

          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
